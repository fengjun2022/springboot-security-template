# 服务间调用权限管理系统 - 快速启动指南

## 🚀 快速启动

### 1. 数据库准备
```bash
# 连接数据库
mysql -h 106.75.7.230 -P 2306 -u root -p

# 执行SQL脚本（会自动创建 zxy_hospital 数据库）
source service_auth.sql;
# 或者
mysql -h 106.75.7.230 -P 2306 -u root -p < service_auth.sql
```

### 2. 启动应用
```bash
# 编译项目
mvn clean compile -DskipTests

# 启动应用
mvn spring-boot:run -pl server
```

### 3. 验证启动
看到以下日志表示启动成功：
```
=== 应用启动完成，开始初始化权限缓存 ===
开始初始化权限缓存...
权限缓存初始化完成，缓存应用数量: 3
=== 权限缓存初始化成功 ===
```

## 📋 快速测试

### 1. 查看预置应用
```bash
curl "http://localhost:8080/api/service-app/list"
```

### 2. 管理员登录
```bash
# 需要先创建admin用户，或使用现有用户
curl -X POST "http://localhost:8080/login" \
     -H "Content-Type: application/json" \
     -d '{"username": "admin", "password": "123456"}'
```

### 3. 注册新应用（需要admin权限）
```bash
curl -X POST "http://localhost:8080/api/service-app/register" \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhZG1pbiIsImxvZ2luVHlwZSI6IlVTRVJfTE9HSU4iLCJleHAiOjE3NTYyNDIwOTUsImF1dGhvcml0aWVzIjoiUk9MRV9BRE1JTiJ9.hLeYToGDExvSjJmlrKHc2NAaA1D79hwrgVhRS2R1hRk" \
     -d '{
       "appName": "测试服务",
       "allowedApis": ["/api/test/*"],
       "createBy": "admin",
       "remark": "测试用服务"
     }'
```

### 4. 签发Token（需要admin权限）
```bash
curl -X POST "http://localhost:8080/api/service-token/issue" \
     -H "Content-Type: application/json" \
     -d '{
       "appId": "713021225472069",
       "authCode": "WsrAHKbqzqloYYudW_lTmJnszxG4L3G1",
       "issueBy": "admin"
     }'
```

### 5. 测试调用权限

#### 👤 用户调用（普通业务接口）
```bash
# 用户调用不需要appid，使用用户token即可
curl -X GET "http://localhost:8080/api/user/profile" \
     -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."

# 用户调用其他业务接口
curl -X GET "http://localhost:8080/api/order/list" \
     -H "Authorization: Bearer {user_token}"
```

#### 🔗 服务间调用（需要appid+服务token）
```bash
# 服务间调用：有权限的接口
curl -X GET "http://localhost:8080/api/test/example" \
     -H "X-Service-Call: true" \
     -H "appid: 713021225472069" \
     -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiI3MTMwMjEyMjU0NzIwNjkiLCJhcHBOYW1lIjoi5rWL6K-V5pyN5YqhIiwiYXBwSWQiOiI3MTMwMjEyMjU0NzIwNjkiLCJpc3MiOiJ6eHktaG9zcGl0YWwtYWRtaW4iLCJ0eXBlIjoicGVybWFuZW50IiwiaWF0IjoxNzU2MjE0Njg2fQ.eCwSeTdCD47IWlH2PvsBloxi82ffnnxCpcr73dezF94"

```

```bash
# 服务间调用：无权限的接口（会返回403）
curl -X GET "http://localhost:8080/api/forbidden/example" \
     -H "X-Service-Call: true" \
     -H "appid: 713021225472069" \
     -H "Authorization: Bearer {service_token}"
```


## 🔧 配置说明

### 数据库配置
当前配置连接开发环境数据库：
- **地址**: 106.75.7.230:2306
- **数据库**: zxy_hospital
- **用户**: root

### 权限说明

#### 🔄 两种调用方式
1. **👤 用户调用**
   - 普通用户访问业务接口
   - 只需要用户token（Spring Security认证）
   - 不需要appid，不经过服务权限验证

2. **🔗 服务间调用**
   - 微服务之间的内部调用
   - 需要 `X-Service-Call: true` + `appid` + `服务token`
   - 经过ServicePermissionFilter权限验证

#### 🔒 管理接口权限
- **管理员权限接口**: 需要ADMIN角色才能访问
  - 应用注册/更新/删除
  - Token签发/失效
  - 缓存管理
- **查询接口**: 无需特殊权限

## 📖 完整文档
详细使用说明请参考：[服务间调用权限管理系统-完整文档.md](./服务间调用权限管理系统-完整文档.md)

## ⚠️ 注意事项
1. **用户调用 vs 服务调用**：
   - 用户调用：不加 `X-Service-Call` 头，走Spring Security用户认证
   - 服务调用：必须加 `X-Service-Call: true` 头，走appid+token验证
2. 首次启动需要先创建管理员用户  
3. 所有管理操作都需要admin权限
4. 服务Token为永久有效，请妥善保管

## 🎯 系统架构
```
服务A ──┐
服务B ──┼──► 权限管理中心 ──► MySQL
服务C ──┘    (高性能缓存)
```

**核心特性**:
- ✅ 永久Token，无需续期
- ✅ 内存缓存，毫秒级验证  
- ✅ 通配符权限，灵活配置
- ✅ Admin权限控制，安全可靠
