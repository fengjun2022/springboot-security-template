# æœåŠ¡é—´è°ƒç”¨Tokenç­¾å‘å’Œæƒé™æ§åˆ¶ç³»ç»Ÿ - å®Œæ•´æ–‡æ¡£

## ç›®å½•
- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
- [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [APIæ¥å£æ–‡æ¡£](#apiæ¥å£æ–‡æ¡£)
- [æƒé™ç®¡ç†](#æƒé™ç®¡ç†)
- [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [ç›‘æ§å’Œç»´æŠ¤](#ç›‘æ§å’Œç»´æŠ¤)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

## ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»Ÿå®ç°äº†ä¸€ä¸ªå®Œæ•´çš„æœåŠ¡é—´è°ƒç”¨æƒé™ç®¡ç†æ–¹æ¡ˆï¼Œä¸ºå¾®æœåŠ¡æ¶æ„æä¾›å®‰å…¨ã€é«˜æ•ˆçš„æœåŠ¡é—´é€šä¿¡æœºåˆ¶ã€‚

### æ ¸å¿ƒåŠŸèƒ½
- **æœåŠ¡åº”ç”¨æ³¨å†Œç®¡ç†**ï¼šåŠ¨æ€æ³¨å†Œå’Œç®¡ç†æœåŠ¡åº”ç”¨ï¼Œè‡ªåŠ¨ç”ŸæˆAppIDå’Œæˆæƒç 
- **æ°¸ä¹…Tokenç­¾å‘**ï¼šåŸºäºJWTçš„æ— è¿‡æœŸæ—¶é—´Tokenï¼Œç¡®ä¿æœåŠ¡é—´é•¿æœŸç¨³å®šé€šä¿¡
- **é«˜æ€§èƒ½æƒé™éªŒè¯**ï¼šå†…å­˜ç¼“å­˜+Filteræœºåˆ¶ï¼Œæ¯«ç§’çº§æƒé™éªŒè¯
- **ç»†ç²’åº¦æƒé™æ§åˆ¶**ï¼šæ”¯æŒç²¾ç¡®åŒ¹é…ã€é€šé…ç¬¦åŒ¹é…ç­‰å¤šç§æƒé™é…ç½®ç­–ç•¥
- **Adminæƒé™ç®¡æ§**ï¼šå…³é”®æ“ä½œä»…é™ç®¡ç†å‘˜è®¿é—®

### æŠ€æœ¯æ¶æ„
- **Spring Boot 2.7.16** - åŸºç¡€æ¡†æ¶
- **Spring Security** - å®‰å…¨æ¡†æ¶
- **JWT (java-jwt 4.2.1)** - TokenæŠ€æœ¯
- **MyBatis** - æ•°æ®è®¿é—®å±‚
- **MySQL** - æ•°æ®å­˜å‚¨
- **é›ªèŠ±IDç®—æ³•** - åˆ†å¸ƒå¼IDç”Ÿæˆ
- **ConcurrentHashMap** - é«˜æ€§èƒ½å†…å­˜ç¼“å­˜

## åŠŸèƒ½ç‰¹æ€§

### 1. æœåŠ¡åº”ç”¨æ³¨å†Œ
- æ”¯æŒåŠ¨æ€æ³¨å†ŒæœåŠ¡åº”ç”¨
- è‡ªåŠ¨ç”ŸæˆAppIDï¼ˆä½¿ç”¨é›ªèŠ±IDï¼‰
- è‡ªåŠ¨ç”Ÿæˆ32ä½å®‰å…¨æˆæƒç 
- é…ç½®å…è®¸è®¿é—®çš„æ¥å£åˆ—è¡¨ï¼ˆJSONæ ¼å¼å­˜å‚¨ï¼‰
- æ”¯æŒåº”ç”¨å¯ç”¨/ç¦ç”¨çŠ¶æ€ç®¡ç†
- **ä»…ç®¡ç†å‘˜å¯æ“ä½œ**ï¼šæ³¨å†Œã€æ›´æ–°ã€åˆ é™¤åº”ç”¨

### 2. Tokenç­¾å‘ç®¡ç†
- åŸºäºJWTçš„æ°¸ä¹…Tokenï¼ˆæ— è¿‡æœŸæ—¶é—´ï¼‰
- Tokenä¸AppIDå¼ºç»‘å®šéªŒè¯
- æ”¯æŒTokené‡æ–°ç”Ÿæˆå’Œæ‰¹é‡å¤±æ•ˆ
- è®°å½•Tokenä½¿ç”¨æƒ…å†µå’Œç»Ÿè®¡ä¿¡æ¯
- **ä»…ç®¡ç†å‘˜å¯æ“ä½œ**ï¼šç­¾å‘ã€å¤±æ•ˆToken

### 3. åŒé‡æƒé™éªŒè¯æœºåˆ¶
- **ç”¨æˆ·è°ƒç”¨æƒé™**ï¼šåŸºäºSpring Securityçš„ç”¨æˆ·è®¤è¯å’Œè§’è‰²æƒé™
- **æœåŠ¡é—´è°ƒç”¨æƒé™**ï¼šåŸºäºServicePermissionFilterçš„appId+tokenéªŒè¯
- **æ™ºèƒ½è¯†åˆ«**ï¼šé€šè¿‡`X-Service-Call`è¯·æ±‚å¤´è‡ªåŠ¨åŒºåˆ†è°ƒç”¨ç±»å‹
- **é«˜æ€§èƒ½ç¼“å­˜**ï¼šConcurrentHashMapå®ç°æ¯«ç§’çº§æƒé™æŸ¥è¯¢
- **ç™½åå•æœºåˆ¶**ï¼šæ’é™¤é™æ€èµ„æºå’Œç®¡ç†æ¥å£ï¼Œé¿å…è¯¯æ‹¦æˆª

### 4. æƒé™é…ç½®ç­–ç•¥
æ”¯æŒå¤šç§çµæ´»çš„æƒé™åŒ¹é…æ¨¡å¼ï¼š
- **ç²¾ç¡®åŒ¹é…**ï¼š`/api/user/profile`
- **å‰ç¼€é€šé…ç¬¦**ï¼š`/api/user/*` 
- **åç¼€é€šé…ç¬¦**ï¼š`*/export`
- **å…¨å±€åŒ¹é…**ï¼š`*`
- **å¤åˆé…ç½®**ï¼šæ··åˆä½¿ç”¨å¤šç§æ¨¡å¼

### 5. ç¼“å­˜ç®¡ç†ç³»ç»Ÿ
- **å¯åŠ¨è‡ªåŠ¨åŠ è½½**ï¼šåº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–æƒé™ç¼“å­˜
- **å®æ—¶åˆ·æ–°**ï¼šæ”¯æŒå•åº”ç”¨å’Œå…¨å±€ç¼“å­˜åˆ·æ–°
- **æ€§èƒ½ç›‘æ§**ï¼šç¼“å­˜å‘½ä¸­ç‡ã€æŸ¥è¯¢ç»Ÿè®¡
- **ç¼“å­˜æ¸…ç†**ï¼šæ”¯æŒæŒ‡å®šåº”ç”¨å’Œå…¨å±€ç¼“å­˜æ¸…ç†
- **ä»…ç®¡ç†å‘˜å¯æ“ä½œ**ï¼šç¼“å­˜ç®¡ç†æ“ä½œ

## æ•°æ®åº“è®¾è®¡

### service_appï¼ˆæœåŠ¡åº”ç”¨è¡¨ï¼‰
```sql
CREATE TABLE `service_app` (
    `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®IDï¼Œè‡ªå¢',
    `app_name` VARCHAR(100) NOT NULL COMMENT 'åº”ç”¨åç§°',
    `app_id` VARCHAR(50) NOT NULL COMMENT 'åº”ç”¨å”¯ä¸€æ ‡è¯†ï¼Œä½¿ç”¨é›ªèŠ±IDç”Ÿæˆ',
    `auth_code` VARCHAR(100) NOT NULL COMMENT 'æˆæƒç ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„å¯†é’¥',
    `allowed_apis` TEXT COMMENT 'å…è®¸è®¿é—®çš„æ¥å£åˆ—è¡¨ï¼ŒJSONæ ¼å¼å­˜å‚¨',
    `status` TINYINT(1) NOT NULL DEFAULT 1 COMMENT 'åº”ç”¨çŠ¶æ€ï¼š1-å¯ç”¨ï¼Œ0-ç¦ç”¨',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    `create_by` VARCHAR(50) COMMENT 'åˆ›å»ºè€…',
    `update_by` VARCHAR(50) COMMENT 'æ›´æ–°è€…',
    `remark` VARCHAR(500) COMMENT 'å¤‡æ³¨',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_app_name` (`app_name`),
    UNIQUE KEY `uk_app_id` (`app_id`),
    KEY `idx_status` (`status`),
    KEY `idx_app_id_status` (`app_id`, `status`)
);
```

### service_tokenï¼ˆæœåŠ¡Tokenè¡¨ï¼‰
```sql
CREATE TABLE `service_token` (
    `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®IDï¼Œè‡ªå¢',
    `app_id` VARCHAR(50) NOT NULL COMMENT 'åº”ç”¨IDï¼Œå…³è”service_appè¡¨',
    `token` TEXT NOT NULL COMMENT 'ç­¾å‘çš„token',
    `token_type` VARCHAR(20) NOT NULL DEFAULT 'permanent' COMMENT 'tokenç±»å‹',
    `status` TINYINT(1) NOT NULL DEFAULT 1 COMMENT 'tokençŠ¶æ€ï¼š1-æœ‰æ•ˆï¼Œ0-å¤±æ•ˆ',
    `issue_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ç­¾å‘æ—¶é—´',
    `last_used_time` DATETIME COMMENT 'æœ€åä½¿ç”¨æ—¶é—´',
    `issue_by` VARCHAR(50) COMMENT 'ç­¾å‘è€…',
    `remark` VARCHAR(500) COMMENT 'å¤‡æ³¨',
    PRIMARY KEY (`id`),
    KEY `idx_app_id_status` (`app_id`, `status`),
    CONSTRAINT `fk_service_token_app_id` FOREIGN KEY (`app_id`) REFERENCES `service_app` (`app_id`)
);
```

### ç¤ºä¾‹æ•°æ®
```sql
INSERT INTO `service_app` VALUES 
(1,'ç”¨æˆ·æœåŠ¡','1750123456789012345','abc123def456ghi789','["/api/user/*","/api/auth/validate"]',1,'2025-01-27 10:00:00','2025-01-27 10:00:00','admin',NULL,'ç”¨æˆ·ç®¡ç†ç›¸å…³æœåŠ¡'),
(2,'è®¢å•æœåŠ¡','1750123456789012346','pqr678stu901vwx234','["/api/order/*","/api/payment/*"]',1,'2025-01-27 10:01:00','2025-01-27 10:01:00','admin',NULL,'è®¢å•å’Œæ”¯ä»˜ç›¸å…³æœåŠ¡'),
(3,'é€šçŸ¥æœåŠ¡','1750123456789012347','efg345hij678klm901','["/api/notification/*","/api/sms/*"]',1,'2025-01-27 10:02:00','2025-01-27 10:02:00','admin',NULL,'æ¶ˆæ¯é€šçŸ¥ç›¸å…³æœåŠ¡');
```

## ç³»ç»Ÿæ¶æ„

### æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ç”¨æˆ·   â”‚â”€â”€â”€â”€ğŸ‘¤ ç”¨æˆ·è°ƒç”¨â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                                     â”‚
â”‚  Web/Mobile â”‚   (ç”¨æˆ·Token)        â”‚         æƒé™ç®¡ç†ä¸­å¿ƒ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚                                     â”‚
                                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚  â”‚    ServicePermissionFilter   â”‚   â”‚
â”‚   æœåŠ¡A     â”‚â”€â”€â”                 â”‚  â”‚                               â”‚   â”‚
â”‚[Token:ABC]  â”‚  â”‚                 â”‚  â”‚  æ£€æŸ¥ X-Service-Call è¯·æ±‚å¤´    â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  ğŸ”— æœåŠ¡é—´è°ƒç”¨    â”‚  â”‚          â†“                   â”‚   â”‚
                 â”‚ (appId+Token)    â”‚  â”‚    æœ‰æ ‡è¯†      â”‚    æ— æ ‡è¯†      â”‚   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                 â”‚  â”‚      â†“        â”‚      â†“        â”‚   â”‚
â”‚   æœåŠ¡B     â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  â”‚  æœåŠ¡æƒé™éªŒè¯   â”‚  è·³è¿‡éªŒè¯      â”‚   â”‚
â”‚[Token:DEF]  â”‚  â”‚                 â”‚  â”‚   - éªŒè¯appid  â”‚   èµ°Spring    â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                 â”‚  â”‚   - éªŒè¯token  â”‚   Security    â”‚   â”‚
                 â”‚                 â”‚  â”‚   - æ£€æŸ¥æƒé™   â”‚               â”‚   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   æœåŠ¡C     â”‚â”€â”€â”˜                 â”‚                                     â”‚
â”‚[Token:GHI]  â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚  â”‚      æƒé™ç¼“å­˜                  â”‚   â”‚
                                   â”‚  â”‚   ConcurrentHashMap          â”‚   â”‚
                                   â”‚  â”‚    - appId -> æ¥å£åˆ—è¡¨        â”‚   â”‚
                                   â”‚  â”‚    - é«˜æ€§èƒ½æŸ¥è¯¢              â”‚   â”‚
                                   â”‚  â”‚    - å®æ—¶ç»Ÿè®¡                â”‚   â”‚
                                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                   â”‚                                     â”‚
                                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                                   â”‚  â”‚       ç®¡ç†API (éœ€ADMINæƒé™)    â”‚   â”‚
                                   â”‚  â”‚    - åº”ç”¨æ³¨å†Œ                 â”‚   â”‚
                                   â”‚  â”‚    - Tokenç­¾å‘                â”‚   â”‚
                                   â”‚  â”‚    - æƒé™é…ç½®                 â”‚   â”‚
                                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚           MySQL             â”‚
                                   â”‚     - service_app          â”‚
                                   â”‚     - service_token        â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. ServicePermissionFilter
```java
@Component
@Order(1) // é«˜ä¼˜å…ˆçº§æ‰§è¡Œ
public class ServicePermissionFilter extends OncePerRequestFilter {
    // éªŒè¯é€»è¾‘ï¼š
    // 1. æ£€æŸ¥X-Service-Callæ ‡è¯†
    // 2. éªŒè¯appidå’Œtoken
    // 3. æŸ¥è¯¢æƒé™ç¼“å­˜
    // 4. åŒ¹é…æ¥å£æƒé™
}
```

#### 2. PermissionCacheService
```java
@Service
public class PermissionCacheServiceImpl implements PermissionCacheService {
    // é«˜æ€§èƒ½ç¼“å­˜ï¼š
    // - ConcurrentHashMapå­˜å‚¨æƒé™
    // - å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½
    // - æ”¯æŒå®æ—¶åˆ·æ–°
    // - ç¼“å­˜ç»Ÿè®¡ç›‘æ§
}
```

#### 3. åŒé‡æƒé™éªŒè¯æµç¨‹
```
è¯·æ±‚åˆ°è¾¾ â†’ ServicePermissionFilter 
    â†“
æ£€æŸ¥ X-Service-Call è¯·æ±‚å¤´
    â†“                    â†“
æœ‰æ ‡è¯†(æœåŠ¡è°ƒç”¨)          æ— æ ‡è¯†(ç”¨æˆ·è°ƒç”¨)
    â†“                    â†“
éªŒè¯ appId + Token     è·³è¿‡ï¼Œèµ°Spring Security
    â†“                    â†“
æŸ¥è¯¢æƒé™ç¼“å­˜            ç”¨æˆ·è®¤è¯ + è§’è‰²æƒé™
    â†“                    â†“
åŒ¹é…æ¥å£æƒé™            ä¸šåŠ¡é€»è¾‘å¤„ç†
    â†“
æ”¾è¡Œ/æ‹’ç»
```

## APIæ¥å£æ–‡æ¡£

### è°ƒç”¨æ–¹å¼è¯´æ˜

#### ğŸ‘¤ ç”¨æˆ·è°ƒç”¨ï¼ˆæ™®é€šä¸šåŠ¡æ¥å£ï¼‰
ç”¨æˆ·é€šè¿‡å‰ç«¯åº”ç”¨è°ƒç”¨ä¸šåŠ¡æ¥å£æ—¶ï¼Œä½¿ç”¨Spring Securityæ ‡å‡†è®¤è¯ï¼š
```http
GET /api/user/profile
Authorization: Bearer {user_jwt_token}
```
**ç‰¹ç‚¹**ï¼š
- ä¸éœ€è¦ `X-Service-Call` è¯·æ±‚å¤´
- ä¸éœ€è¦ `appid` å‚æ•°
- ä½¿ç”¨ç”¨æˆ·JWT Token
- ç»è¿‡Spring Securityç”¨æˆ·è®¤è¯å’Œè§’è‰²æƒé™éªŒè¯

#### ğŸ”— æœåŠ¡é—´è°ƒç”¨ï¼ˆå¾®æœåŠ¡å†…éƒ¨é€šä¿¡ï¼‰
å¾®æœåŠ¡ä¹‹é—´è¿›è¡Œå†…éƒ¨è°ƒç”¨æ—¶ï¼Œä½¿ç”¨æœåŠ¡æƒé™éªŒè¯ï¼š
```http
GET /api/notification/send
X-Service-Call: true
appid: 1750123456789012345
Authorization: Bearer {service_permanent_token}
```
**ç‰¹ç‚¹**ï¼š
- å¿…é¡»åŒ…å« `X-Service-Call: true` è¯·æ±‚å¤´
- å¿…é¡»åŒ…å« `appid` å‚æ•°ï¼ˆæœåŠ¡åº”ç”¨IDï¼‰
- ä½¿ç”¨æ°¸ä¹…æœåŠ¡Token
- ç»è¿‡ServicePermissionFilteræƒé™éªŒè¯

### æƒé™è¯´æ˜
ğŸ”’ è¡¨ç¤ºéœ€è¦adminæƒé™çš„æ¥å£
ğŸ‘¤ è¡¨ç¤ºç”¨æˆ·è°ƒç”¨æ¥å£
ğŸ”— è¡¨ç¤ºæœåŠ¡é—´è°ƒç”¨æ¥å£

### æœåŠ¡åº”ç”¨ç®¡ç† (/api/service-app)

#### 1. ğŸ”’ æ³¨å†ŒæœåŠ¡åº”ç”¨
```http
POST /api/service-app/register
Content-Type: application/json
Authorization: Bearer {admin_token}

{
    "appName": "ç”¨æˆ·æœåŠ¡",
    "allowedApis": ["/api/user/*", "/api/auth/validate"],
    "createBy": "admin",
    "remark": "ç”¨æˆ·ç®¡ç†ç›¸å…³æœåŠ¡"
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "id": 1,
        "appName": "ç”¨æˆ·æœåŠ¡",
        "appId": "1750123456789012345",
        "authCode": "abc123def456ghi789jkl012mno345",
        "allowedApis": "[\"/api/user/*\", \"/api/auth/validate\"]",
        "status": 1,
        "createTime": "2025-01-27T10:00:00"
    }
}
```

#### 2. æŸ¥è¯¢æ‰€æœ‰åº”ç”¨
```http
GET /api/service-app/list
```

#### 3. æŸ¥è¯¢å¯ç”¨åº”ç”¨
```http
GET /api/service-app/enabled
```

#### 4. æ ¹æ®IDæŸ¥è¯¢
```http
GET /api/service-app/{id}
```

#### 5. ğŸ”’ æ›´æ–°åº”ç”¨
```http
PUT /api/service-app/update
Content-Type: application/json
Authorization: Bearer {admin_token}

{
    "id": 1,
    "appName": "ç”¨æˆ·æœåŠ¡-æ›´æ–°",
    "allowedApiList": ["/api/user/*", "/api/auth/*"],
    "updateBy": "admin"
}
```

#### 6. ğŸ”’ æ›´æ–°åº”ç”¨çŠ¶æ€
```http
PUT /api/service-app/{id}/status?status=0
Authorization: Bearer {admin_token}
```

#### 7. ğŸ”’ åˆ é™¤åº”ç”¨
```http
DELETE /api/service-app/{id}
Authorization: Bearer {admin_token}
```

#### 8. éªŒè¯åº”ç”¨
```http
POST /api/service-app/validate
Content-Type: application/x-www-form-urlencoded

appId=1750123456789012345&authCode=abc123def456ghi789
```

#### 9. æ£€æŸ¥æƒé™
```http
GET /api/service-app/permission/check?appId=1750123456789012345&apiPath=/api/user/profile
```

### Tokenç®¡ç† (/api/service-token)

#### 1. ğŸ”’ ç­¾å‘Token
```http
POST /api/service-token/issue
Content-Type: application/json
Authorization: Bearer {admin_token}

{
    "appId": "1750123456789012345",
    "authCode": "abc123def456ghi789",
    "issueBy": "admin"
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "id": 1,
        "appId": "1750123456789012345",
        "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "tokenType": "permanent",
        "status": 1,
        "issueTime": "2025-01-27T10:00:00"
    }
}
```

#### 2. éªŒè¯Token
```http
POST /api/service-token/validate?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...
```

#### 3. æ ¹æ®AppIDè·å–Token
```http
GET /api/service-token/app/{appId}
```

#### 4. ğŸ”’ å¤±æ•ˆToken
```http
PUT /api/service-token/{tokenId}/invalidate
Authorization: Bearer {admin_token}
```

#### 5. ğŸ”’ é‡æ–°ç”ŸæˆToken
```http
POST /api/service-token/regenerate
Content-Type: application/json
Authorization: Bearer {admin_token}

{
    "appId": "1750123456789012345",
    "authCode": "abc123def456ghi789",
    "issueBy": "admin"
}
```

#### 6. ğŸ”’ æ‰¹é‡å¤±æ•ˆToken
```http
PUT /api/service-token/app/{appId}/invalidate
Authorization: Bearer {admin_token}
```

### æƒé™ç¼“å­˜ç®¡ç† (/api/permission-cache)

#### 1. ğŸ”’ åˆå§‹åŒ–ç¼“å­˜
```http
POST /api/permission-cache/init
Authorization: Bearer {admin_token}
```

#### 2. ğŸ”’ åˆ·æ–°åº”ç”¨æƒé™ç¼“å­˜
```http
POST /api/permission-cache/refresh/{appId}
Authorization: Bearer {admin_token}
```

#### 3. ğŸ”’ æ¸…é™¤åº”ç”¨æƒé™ç¼“å­˜
```http
DELETE /api/permission-cache/{appId}
Authorization: Bearer {admin_token}
```

#### 4. è·å–åº”ç”¨æƒé™åˆ—è¡¨
```http
GET /api/permission-cache/{appId}/permissions
```

#### 5. æ£€æŸ¥æƒé™
```http
GET /api/permission-cache/check?appId=1750123456789012345&apiPath=/api/user/profile
```

#### 6. ğŸ”’ æ¸…é™¤æ‰€æœ‰ç¼“å­˜
```http
DELETE /api/permission-cache/clear
Authorization: Bearer {admin_token}
```

#### 7. è·å–ç¼“å­˜ç»Ÿè®¡
```http
GET /api/permission-cache/stats
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
    "code": 200,
    "message": "success",
    "data": "ç¼“å­˜ç»Ÿè®¡ - æ€»è¯·æ±‚: 1000, å‘½ä¸­: 950, æœªå‘½ä¸­: 50, å‘½ä¸­ç‡: 95.00%, ç¼“å­˜åº”ç”¨æ•°: 3"
}
```

## æƒé™ç®¡ç†

### ç®¡ç†å‘˜æƒé™è®¾è®¡

ç³»ç»Ÿé‡‡ç”¨**åŒé‡æƒé™æ§åˆ¶**æœºåˆ¶ï¼š

#### 1. Spring Securityæ–¹æ³•çº§æƒé™
å…³é”®ç®¡ç†æ“ä½œä½¿ç”¨`@PreAuthorize("hasRole('ADMIN')")`æ³¨è§£ä¿æŠ¤ï¼š
- æœåŠ¡åº”ç”¨çš„æ³¨å†Œã€æ›´æ–°ã€åˆ é™¤
- Tokençš„ç­¾å‘ã€å¤±æ•ˆã€é‡æ–°ç”Ÿæˆ  
- æƒé™ç¼“å­˜çš„ç®¡ç†æ“ä½œ

#### 2. æœåŠ¡é—´è°ƒç”¨æƒé™
ä¸šåŠ¡æ¥å£ä½¿ç”¨ServicePermissionFilterè¿›è¡Œæƒé™éªŒè¯ã€‚

### æƒé™é…ç½®ç­–ç•¥è¯¦è§£

#### ç²¾ç¡®åŒ¹é…
é€‚ç”¨äºéœ€è¦ç²¾ç¡®æ§åˆ¶çš„ç‰¹å®šæ¥å£ï¼š
```json
["/api/user/profile", "/api/user/settings", "/api/order/create"]
```

#### é€šé…ç¬¦åŒ¹é…
é€‚ç”¨äºæ¨¡å—çº§æƒé™æ§åˆ¶ï¼š

**å‰ç¼€åŒ¹é…ï¼š**
```json
["/api/user/*"]  // åŒ¹é… /api/user/list, /api/user/profile ç­‰
```

**åç¼€åŒ¹é…ï¼š**
```json
["*/export"]     // åŒ¹é… /api/user/export, /api/order/export ç­‰
```

**å…¨å±€åŒ¹é…ï¼š**
```json
["*"]           // åŒ¹é…æ‰€æœ‰æ¥å£ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
```

#### æ··åˆé…ç½®ç¤ºä¾‹
å®é™…ç”Ÿäº§ç¯å¢ƒæ¨èçš„é…ç½®ç­–ç•¥ï¼š
```json
{
    "appName": "ç”¨æˆ·æœåŠ¡",
    "allowedApis": [
        "/api/user/*",           // ç”¨æˆ·æ¨¡å—æ‰€æœ‰æ¥å£
        "/api/auth/validate",    // ç‰¹å®šçš„è®¤è¯æ¥å£
        "/api/system/health",    // å¥åº·æ£€æŸ¥æ¥å£
        "*/export",              // æ‰€æœ‰å¯¼å‡ºæ¥å£
        "/api/common/upload"     // ç‰¹å®šçš„å…¬å…±æ¥å£
    ]
}
```

### æƒé™éªŒè¯æµç¨‹
```
1. è¯·æ±‚åˆ°è¾¾ ServicePermissionFilter
2. æ£€æŸ¥è¯·æ±‚å¤´ï¼šX-Service-Call: true
3. æå–å¹¶éªŒè¯ï¼šappid å’Œ Authorization Token
4. ä»ç¼“å­˜æŸ¥è¯¢åº”ç”¨æƒé™åˆ—è¡¨
5. ä½¿ç”¨åŒ¹é…ç®—æ³•éªŒè¯æ¥å£æƒé™
6. è®°å½•è®¿é—®æ—¥å¿—å’Œç»Ÿè®¡ä¿¡æ¯
7. æ”¾è¡Œè¯·æ±‚æˆ–è¿”å›403é”™è¯¯
```

## éƒ¨ç½²æŒ‡å—

### 1. ç¯å¢ƒè¦æ±‚
- **JDK 1.8+**
- **MySQL 5.7+**
- **Maven 3.6+**
- **Spring Boot 2.7.16**

### 2. æ•°æ®åº“å‡†å¤‡
```bash
# 1. åˆ›å»ºæ•°æ®åº“
mysql -u root -p
CREATE DATABASE zxy_hospital DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 2. æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
mysql -u root -p zxy_hospital < service_auth.sql
```

### 3. é…ç½®æ–‡ä»¶
æ›´æ–° `application-{env}.yml` é…ç½®ï¼š
```yaml
sbt:
  datasource:
    host: your_mysql_host
    port: 3306
    database: zxy_hospital
    username: your_username
    password: your_password
```

### 4. ç¼–è¯‘éƒ¨ç½²
```bash
# ç¼–è¯‘é¡¹ç›®
mvn clean compile -DskipTests

# æ‰“åŒ…é¡¹ç›®
mvn clean package -DskipTests

# å¯åŠ¨åº”ç”¨
java -jar server/target/server-1.0.0.jar --spring.profiles.active=prod
```

### 5. éªŒè¯éƒ¨ç½²
```bash
# æ£€æŸ¥åº”ç”¨å¯åŠ¨çŠ¶æ€
curl http://localhost:8080/api/permission-cache/stats

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
tail -f logs/system.log
```

å¯åŠ¨æˆåŠŸåä¼šçœ‹åˆ°ï¼š
```
=== åº”ç”¨å¯åŠ¨å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æƒé™ç¼“å­˜ ===
å¼€å§‹åˆå§‹åŒ–æƒé™ç¼“å­˜...
æƒé™ç¼“å­˜åˆå§‹åŒ–å®Œæˆï¼Œç¼“å­˜åº”ç”¨æ•°é‡: 3
=== æƒé™ç¼“å­˜åˆå§‹åŒ–æˆåŠŸ ===
```

## ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´å·¥ä½œæµç¨‹ç¤ºä¾‹

#### åœºæ™¯ï¼šç”¨æˆ·æœåŠ¡éœ€è¦è°ƒç”¨é€šçŸ¥æœåŠ¡å‘é€é‚®ä»¶

#### æ­¥éª¤1ï¼šç®¡ç†å‘˜ç™»å½•å¹¶æ³¨å†Œé€šçŸ¥æœåŠ¡
```bash
# 1. ç®¡ç†å‘˜ç™»å½•è·å–token
curl -X POST "http://localhost:8080/login" \
     -H "Content-Type: application/json" \
     -d '{"username": "admin", "password": "admin123"}'

# å“åº”è·å–admin_token
# {"code":200,"data":{"token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."}}

# 2. æ³¨å†Œé€šçŸ¥æœåŠ¡åº”ç”¨
curl -X POST "http://localhost:8080/api/service-app/register" \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer {admin_token}" \
     -d '{
       "appName": "é€šçŸ¥æœåŠ¡",
       "allowedApis": ["/api/notification/*", "/api/sms/send", "/api/email/send"],
       "createBy": "admin",
       "remark": "æ¶ˆæ¯é€šçŸ¥æœåŠ¡"
     }'
```

#### æ­¥éª¤2ï¼šä¸ºé€šçŸ¥æœåŠ¡ç­¾å‘Token
```bash
curl -X POST "http://localhost:8080/api/service-token/issue" \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer {admin_token}" \
     -d '{
       "appId": "1750123456789012346",
       "authCode": "xyz789abc456def123ghi789jkl012",
       "issueBy": "admin"
     }'
```

#### æ­¥éª¤3ï¼šæµ‹è¯•ä¸¤ç§è°ƒç”¨æ–¹å¼

##### ğŸ‘¤ ç”¨æˆ·è°ƒç”¨ç¤ºä¾‹ï¼ˆç”¨æˆ·é€šè¿‡å‰ç«¯è®¿é—®æ¥å£ï¼‰
```bash
# ç”¨æˆ·ç™»å½•è·å–ç”¨æˆ·token
curl -X POST "http://localhost:8080/login" \
     -H "Content-Type: application/json" \
     -d '{"username": "user", "password": "password"}'

# ç”¨æˆ·è°ƒç”¨ä¸šåŠ¡æ¥å£ï¼ˆä¸éœ€è¦appidï¼‰
curl -X GET "http://localhost:8080/api/user/profile" \
     -H "Authorization: Bearer {user_token}"

curl -X GET "http://localhost:8080/api/order/list" \
     -H "Authorization: Bearer {user_token}"
```

##### ğŸ”— æœåŠ¡é—´è°ƒç”¨ç¤ºä¾‹ï¼ˆå¾®æœåŠ¡å†…éƒ¨é€šä¿¡ï¼‰
```bash
# ç”¨æˆ·æœåŠ¡è°ƒç”¨é€šçŸ¥æœåŠ¡å‘é€æ¬¢è¿é‚®ä»¶
curl -X POST "http://localhost:8080/api/email/send" \
     -H "Content-Type: application/json" \
     -H "X-Service-Call: true" \
     -H "appid: 1750123456789012346" \
     -H "Authorization: Bearer {service_token}" \
     -d '{
       "to": "user@example.com",
       "subject": "æ¬¢è¿æ³¨å†Œ",
       "content": "æ¬¢è¿æ‚¨æ³¨å†Œæˆ‘ä»¬çš„æœåŠ¡ï¼"
     }'
```

### Javaä»£ç ç¤ºä¾‹

#### åœ¨Spring BootæœåŠ¡ä¸­è¿›è¡ŒæœåŠ¡é—´è°ƒç”¨
```java
@Service
public class UserNotificationService {
    
    private static final String NOTIFICATION_SERVICE_APP_ID = "1750123456789012346";
    private static final String NOTIFICATION_SERVICE_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...";
    
    @Autowired
    private RestTemplate restTemplate;
    
    public void sendWelcomeEmail(String userEmail, String userName) {
        // è®¾ç½®æœåŠ¡é—´è°ƒç”¨çš„è¯·æ±‚å¤´
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.set("X-Service-Call", "true");
        headers.set("appid", NOTIFICATION_SERVICE_APP_ID);
        headers.set("Authorization", "Bearer " + NOTIFICATION_SERVICE_TOKEN);
        
        // æ„å»ºè¯·æ±‚ä½“
        Map<String, Object> emailRequest = new HashMap<>();
        emailRequest.put("to", userEmail);
        emailRequest.put("subject", "æ¬¢è¿æ³¨å†Œ");
        emailRequest.put("content", "æ¬¢è¿æ‚¨ï¼Œ" + userName + "ï¼");
        
        HttpEntity<Map<String, Object>> requestEntity = new HttpEntity<>(emailRequest, headers);
        
        // å‘èµ·æœåŠ¡é—´è°ƒç”¨
        try {
            ResponseEntity<String> response = restTemplate.postForEntity(
                "http://notification-service/api/email/send", 
                requestEntity, 
                String.class
            );
            
            if (response.getStatusCode().is2xxSuccessful()) {
                System.out.println("æ¬¢è¿é‚®ä»¶å‘é€æˆåŠŸ");
            }
        } catch (Exception e) {
            System.err.println("å‘é€æ¬¢è¿é‚®ä»¶å¤±è´¥: " + e.getMessage());
        }
    }
}
```

#### é…ç½®RestTemplate Bean
```java
@Configuration
public class ServiceConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

#### Tokené…ç½®ç®¡ç†
```java
@Component
@ConfigurationProperties(prefix = "service.tokens")
public class ServiceTokenConfig {
    
    private Map<String, TokenInfo> services = new HashMap<>();
    
    @Data
    public static class TokenInfo {
        private String appId;
        private String token;
    }
    
    public TokenInfo getServiceToken(String serviceName) {
        return services.get(serviceName);
    }
    
    // getters and setters
}
```

å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼š
```yaml
service:
  tokens:
    notification:
      appId: "1750123456789012346"
      token: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
    user:
      appId: "1750123456789012345"
      token: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
```

### æƒé™åŠ¨æ€ç®¡ç†ç¤ºä¾‹

#### 1. æŸ¥çœ‹å½“å‰æƒé™é…ç½®
```bash
# æŸ¥çœ‹æ‰€æœ‰åº”ç”¨
curl "http://localhost:8080/api/service-app/list"

# æŸ¥çœ‹æŒ‡å®šåº”ç”¨æƒé™
curl "http://localhost:8080/api/permission-cache/1750123456789012345/permissions"
```

#### 2. åŠ¨æ€æ›´æ–°æƒé™
```bash
# æ›´æ–°åº”ç”¨æƒé™
curl -X PUT "http://localhost:8080/api/service-app/update" \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer {admin_token}" \
     -d '{
       "id": 1,
       "appName": "ç”¨æˆ·æœåŠ¡",
       "allowedApiList": ["/api/user/*", "/api/auth/*", "/api/profile/*", "/api/settings/*"],
       "updateBy": "admin"
     }'

# åˆ·æ–°æƒé™ç¼“å­˜
curl -X POST "http://localhost:8080/api/permission-cache/refresh/1750123456789012345" \
     -H "Authorization: Bearer {admin_token}"
```

#### 3. æƒé™éªŒè¯æµ‹è¯•
```bash
# æµ‹è¯•æœ‰æƒé™çš„æ¥å£
curl -X GET "http://localhost:8080/api/user/list" \
     -H "X-Service-Call: true" \
     -H "appid: 1750123456789012345" \
     -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."

# æµ‹è¯•æ— æƒé™çš„æ¥å£ï¼ˆåº”è¯¥è¿”å›403ï¼‰
curl -X GET "http://localhost:8080/api/order/list" \
     -H "X-Service-Call: true" \
     -H "appid: 1750123456789012345" \
     -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
```

## ç›‘æ§å’Œç»´æŠ¤

### 1. æ€§èƒ½ç›‘æ§

#### ç¼“å­˜æ€§èƒ½ç›‘æ§
```bash
# è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
curl "http://localhost:8080/api/permission-cache/stats"

# å“åº”ç¤ºä¾‹
{
    "code": 200,
    "data": "ç¼“å­˜ç»Ÿè®¡ - æ€»è¯·æ±‚: 10000, å‘½ä¸­: 9500, æœªå‘½ä¸­: 500, å‘½ä¸­ç‡: 95.00%, ç¼“å­˜åº”ç”¨æ•°: 5"
}
```

#### å…³é”®æŒ‡æ ‡ç›‘æ§
å»ºè®®ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼š>95%ä¸ºå¥åº·çŠ¶æ€
- **æƒé™éªŒè¯å“åº”æ—¶é—´**ï¼š<5msä¸ºæ­£å¸¸
- **TokenéªŒè¯æˆåŠŸç‡**ï¼š>98%ä¸ºæ­£å¸¸
- **æœåŠ¡è°ƒç”¨é¢‘ç‡**ï¼šç›‘æ§å¼‚å¸¸å³°å€¼

#### æ—¥å¿—ç›‘æ§
ç³»ç»Ÿä¼šè¾“å‡ºå…³é”®æ“ä½œæ—¥å¿—ï¼š
```
2025-01-27 10:00:00 INFO  - æƒé™ç¼“å­˜åˆå§‹åŒ–å®Œæˆï¼Œç¼“å­˜åº”ç”¨æ•°é‡: 5
2025-01-27 10:01:00 WARN  - TokenéªŒè¯å¤±è´¥ï¼ŒappId: 1750123456789012345
2025-01-27 10:02:00 ERROR - æ— æƒé™è®¿é—®æ¥å£: /api/order/list, appId: 1750123456789012345
```

### 2. ç¼“å­˜ç®¡ç†

#### å®šæœŸç¼“å­˜ç»´æŠ¤
```bash
# æ¯æ—¥å®šæ—¶åˆ·æ–°ç¼“å­˜
0 2 * * * curl -X POST "http://localhost:8080/api/permission-cache/init" -H "Authorization: Bearer {admin_token}"

# ç›‘æ§ç¼“å­˜çŠ¶æ€
*/5 * * * * curl "http://localhost:8080/api/permission-cache/stats" | logger -t cache-monitor
```

#### ç¼“å­˜æ•…éšœå¤„ç†
```bash
# ç¼“å­˜å¼‚å¸¸æ—¶é‡æ–°åˆå§‹åŒ–
curl -X DELETE "http://localhost:8080/api/permission-cache/clear" \
     -H "Authorization: Bearer {admin_token}"
     
curl -X POST "http://localhost:8080/api/permission-cache/init" \
     -H "Authorization: Bearer {admin_token}"
```

### 3. Tokenç®¡ç†ç»´æŠ¤

#### Tokenä½¿ç”¨æƒ…å†µæ£€æŸ¥
```bash
# æ£€æŸ¥é•¿æ—¶é—´æœªä½¿ç”¨çš„token
SELECT app_id, token_type, issue_time, last_used_time, 
       DATEDIFF(NOW(), last_used_time) as days_unused
FROM service_token 
WHERE status = 1 
  AND last_used_time < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

#### Tokenå®‰å…¨è½®æ¢
```bash
# å®šæœŸé‡æ–°ç”Ÿæˆtokenï¼ˆå»ºè®®æ¯å­£åº¦ï¼‰
curl -X POST "http://localhost:8080/api/service-token/regenerate" \
     -H "Authorization: Bearer {admin_token}" \
     -d "appId={appId}&authCode={authCode}&issueBy=system"
```

### 4. æ•°æ®åº“ç»´æŠ¤

#### æ€§èƒ½ä¼˜åŒ–SQL
```sql
-- æ¸…ç†è¿‡æœŸçš„å¤±æ•ˆtokenè®°å½•ï¼ˆä¿ç•™6ä¸ªæœˆï¼‰
DELETE FROM service_token 
WHERE status = 0 
  AND issue_time < DATE_SUB(NOW(), INTERVAL 6 MONTH);

-- åˆ†æè¡¨æ€§èƒ½
ANALYZE TABLE service_app, service_token;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT * FROM information_schema.processlist WHERE time > 1;
```

#### æ•°æ®å¤‡ä»½ç­–ç•¥
```bash
# æ¯æ—¥å¤‡ä»½è„šæœ¬
#!/bin/bash
backup_date=$(date +%Y%m%d)
mysqldump -u root -p zxy_hospital service_app service_token > backup_${backup_date}.sql
find ./backups -name "backup_*.sql" -mtime +30 -delete
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. æƒé™éªŒè¯å¤±è´¥ (403 Forbidden)

**é—®é¢˜ç°è±¡ï¼š**
```json
{
    "code": 403,
    "message": "æ— æƒé™è®¿é—®è¯¥æ¥å£: /api/user/profile"
}
```

**æ’æŸ¥æ­¥éª¤ï¼š**
```bash
# 1. æ£€æŸ¥åº”ç”¨æ˜¯å¦å­˜åœ¨ä¸”å¯ç”¨
curl "http://localhost:8080/api/service-app/list" | grep "appId"

# 2. æ£€æŸ¥æƒé™é…ç½®
curl "http://localhost:8080/api/permission-cache/{appId}/permissions"

# 3. éªŒè¯æ¥å£è·¯å¾„åŒ¹é…
curl "http://localhost:8080/api/permission-cache/check?appId={appId}&apiPath=/api/user/profile"

# 4. åˆ·æ–°æƒé™ç¼“å­˜
curl -X POST "http://localhost:8080/api/permission-cache/refresh/{appId}" \
     -H "Authorization: Bearer {admin_token}"
```

**è§£å†³æ–¹æ¡ˆï¼š**
- ç¡®è®¤appIdæ­£ç¡®ä¸”åº”ç”¨çŠ¶æ€ä¸ºå¯ç”¨
- æ£€æŸ¥æƒé™é…ç½®æ˜¯å¦åŒ…å«ç›®æ ‡æ¥å£
- æ›´æ–°æƒé™é…ç½®å¹¶åˆ·æ–°ç¼“å­˜

#### 2. TokenéªŒè¯å¤±è´¥

**é—®é¢˜ç°è±¡ï¼š**
```json
{
    "code": 401,
    "message": "TokenéªŒè¯å¤±è´¥"
}
```

**æ’æŸ¥æ­¥éª¤ï¼š**
```bash
# 1. éªŒè¯tokenæ ¼å¼
echo "Token: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."

# 2. æ£€æŸ¥tokençŠ¶æ€
curl -X POST "http://localhost:8080/api/service-token/validate?token={token}"

# 3. éªŒè¯appIdä¸tokenåŒ¹é…
curl "http://localhost:8080/api/service-token/app/{appId}"
```

**è§£å†³æ–¹æ¡ˆï¼š**
- ç¡®è®¤tokenæ ¼å¼æ­£ç¡®ï¼ˆBearerå‰ç¼€ï¼‰
- æ£€æŸ¥tokenæ˜¯å¦å·²å¤±æ•ˆ
- é‡æ–°ç”Ÿæˆtoken

#### 3. ç¼“å­˜æœªç”Ÿæ•ˆ

**é—®é¢˜ç°è±¡ï¼š**
ç¼“å­˜å‘½ä¸­ç‡ä½æˆ–æƒé™æ›´æ–°åæœªç”Ÿæ•ˆ

**æ’æŸ¥æ­¥éª¤ï¼š**
```bash
# 1. æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
curl "http://localhost:8080/api/permission-cache/stats"

# 2. æ£€æŸ¥åº”ç”¨å¯åŠ¨æ—¥å¿—
grep "æƒé™ç¼“å­˜" logs/system.log

# 3. æŸ¥çœ‹æ•°æ®åº“è¿æ¥
curl "http://localhost:8080/api/service-app/enabled"
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ‰‹åŠ¨é‡æ–°åˆå§‹åŒ–ç¼“å­˜
curl -X POST "http://localhost:8080/api/permission-cache/init" \
     -H "Authorization: Bearer {admin_token}"

# æ¸…é™¤å¹¶é‡å»ºç¼“å­˜
curl -X DELETE "http://localhost:8080/api/permission-cache/clear" \
     -H "Authorization: Bearer {admin_token}"
```

#### 4. æ•°æ®åº“è¿æ¥é—®é¢˜

**é—®é¢˜ç°è±¡ï¼š**
```
SQLException: No database selected
æˆ–
Could not connect to database
```

**è§£å†³æ–¹æ¡ˆï¼š**
```yaml
# æ£€æŸ¥é…ç½®æ–‡ä»¶
sbt:
  datasource:
    host: your_host
    port: 3306
    database: zxy_hospital  # ç¡®ä¿æ•°æ®åº“åæ­£ç¡®
    username: your_username
    password: your_password
```

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -h your_host -P 3306 -u your_username -p zxy_hospital
```

#### 5. æœåŠ¡è°ƒç”¨è¢«è¯¯æ‹¦æˆª

**é—®é¢˜ç°è±¡ï¼š**
æ­£å¸¸ä¸šåŠ¡æ¥å£è¢«ServicePermissionFilteræ‹¦æˆª

**è§£å†³æ–¹æ¡ˆï¼š**
æ£€æŸ¥è¯·æ±‚å¤´ï¼Œåªæœ‰åŒ…å«`X-Service-Call: true`çš„è¯·æ±‚æ‰ä¼šè¢«æƒé™éªŒè¯ï¼š
```bash
# æ™®é€šç”¨æˆ·è¯·æ±‚ï¼ˆä¸ä¼šè¢«æ‹¦æˆªï¼‰
curl -X GET "http://localhost:8080/api/user/profile" \
     -H "Authorization: Bearer {user_token}"

# æœåŠ¡é—´è°ƒç”¨ï¼ˆä¼šè¢«æƒé™éªŒè¯ï¼‰
curl -X GET "http://localhost:8080/api/user/profile" \
     -H "X-Service-Call: true" \
     -H "appid: {appId}" \
     -H "Authorization: Bearer {service_token}"
```

### æ€§èƒ½é—®é¢˜æ’æŸ¥

#### 1. å“åº”æ—¶é—´è¿‡é•¿
```bash
# æ£€æŸ¥æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
SHOW PROCESSLIST;

# æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—
SHOW VARIABLES LIKE 'slow_query_log';

# åˆ†æç¼“å­˜å‘½ä¸­ç‡
curl "http://localhost:8080/api/permission-cache/stats"
```

#### 2. å†…å­˜ä½¿ç”¨è¿‡é«˜
```bash
# æ£€æŸ¥ç¼“å­˜å¤§å°
curl "http://localhost:8080/api/permission-cache/stats"

# æ¸…ç†æ— ç”¨ç¼“å­˜
curl -X DELETE "http://localhost:8080/api/permission-cache/clear" \
     -H "Authorization: Bearer {admin_token}"
```

### æ—¥å¿—åˆ†æ

#### å…³é”®æ—¥å¿—ä½ç½®
- **åº”ç”¨æ—¥å¿—**ï¼š`logs/system.log`
- **æƒé™éªŒè¯æ—¥å¿—**ï¼šæœç´¢`ServicePermissionFilter`
- **ç¼“å­˜æ“ä½œæ—¥å¿—**ï¼šæœç´¢`PermissionCache`

#### æ—¥å¿—åˆ†æå‘½ä»¤
```bash
# æŸ¥çœ‹æƒé™éªŒè¯å¤±è´¥çš„è®°å½•
grep "æ— æƒé™è®¿é—®" logs/system.log | tail -20

# ç»Ÿè®¡tokenéªŒè¯å¤±è´¥æ¬¡æ•°
grep "TokenéªŒè¯å¤±è´¥" logs/system.log | wc -l

# ç›‘æ§å®æ—¶æ—¥å¿—
tail -f logs/system.log | grep -E "(æƒé™|Token|Cache)"
```

---

## æ€»ç»“

æœ¬ç³»ç»Ÿä¸ºå¾®æœåŠ¡æ¶æ„æä¾›äº†å®Œæ•´çš„æœåŠ¡é—´è°ƒç”¨æƒé™ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

### ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿
- **é«˜æ€§èƒ½**ï¼šå†…å­˜ç¼“å­˜ + é«˜æ•ˆç®—æ³•ï¼Œæ¯«ç§’çº§æƒé™éªŒè¯
- **é«˜å®‰å…¨**ï¼šJWT Token + æˆæƒç åŒé‡éªŒè¯ï¼Œadminæƒé™ç®¡æ§
- **é«˜å¯ç”¨**ï¼šç¼“å­˜å®¹é”™æœºåˆ¶ï¼ŒæœåŠ¡é‡å¯è‡ªåŠ¨æ¢å¤
- **æ˜“ç®¡ç†**ï¼šå®Œå–„çš„APIæ¥å£ï¼Œæ”¯æŒåŠ¨æ€æƒé™é…ç½®
- **æ˜“æ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒè‡ªå®šä¹‰æƒé™ç­–ç•¥

### ğŸš€ ç”Ÿäº§å»ºè®®
- **ç›‘æ§å‘Šè­¦**ï¼šé…ç½®ç¼“å­˜å‘½ä¸­ç‡ã€å“åº”æ—¶é—´ç›‘æ§
- **å®šæœŸç»´æŠ¤**ï¼šTokenè½®æ¢ã€ç¼“å­˜æ¸…ç†ã€æ•°æ®å¤‡ä»½
- **å®‰å…¨åŠ å›º**ï¼šHTTPSä¼ è¾“ã€æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
- **æ€§èƒ½ä¼˜åŒ–**ï¼šæ ¹æ®ä¸šåŠ¡é‡è°ƒæ•´ç¼“å­˜ç­–ç•¥å’Œæ•°æ®åº“è¿æ¥æ± 

### ğŸ“ æŠ€æœ¯æ”¯æŒ
å¦‚é‡åˆ°é—®é¢˜ï¼Œå¯é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–æ”¯æŒï¼š
- æŸ¥çœ‹è¯¦ç»†çš„APIæ–‡æ¡£å’Œé”™è¯¯ç è¯´æ˜
- åˆ†æç³»ç»Ÿæ—¥å¿—å’Œæ€§èƒ½ç›‘æ§æ•°æ®
- å‚è€ƒæ•…éšœæ’é™¤ç« èŠ‚çš„è§£å†³æ–¹æ¡ˆ

æœ¬ç³»ç»Ÿå·²åœ¨ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼Œå¯ä¸ºä¼ä¸šçº§å¾®æœåŠ¡æ¶æ„æä¾›ç¨³å®šå¯é çš„æƒé™ç®¡ç†æœåŠ¡ï¼
