<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org"
    th:replace="~{admin/layout :: layout(pageTitle=~{::title}, content=~{::#content}, scripts=~{::#scripts})}">

<head>
    <title>系统监控 - 权限管理系统</title>
</head>

<body>
    <div id="content">
        <!-- 登录状态显示 -->
        <div id="pageLoginStatus" class="alert alert-info mb-3" style="display: none;">
            <i class="fas fa-info-circle me-2"></i>
            <span id="pageStatusText">正在检查登录状态...</span>
        </div>

        <!-- 系统概览卡片 -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="card bg-primary text-white mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                <div class="card-body-icon">
                                    <i class="fas fa-server"></i>
                                </div>
                                <div class="mr-5">
                                    <strong id="systemStatus">正常</strong>
                                    <br><small>系统状态</small>
                                </div>
                            </div>
                            <div class="col-4 text-right">
                                <i class="fas fa-server fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="card bg-success text-white mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                <div class="card-body-icon">
                                    <i class="fas fa-memory"></i>
                                </div>
                                <div class="mr-5">
                                    <strong id="memoryUsage">0%</strong>
                                    <br><small>内存使用</small>
                                </div>
                            </div>
                            <div class="col-4 text-right">
                                <i class="fas fa-memory fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="card bg-warning text-white mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                <div class="card-body-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="mr-5">
                                    <strong id="uptime">0h 0m</strong>
                                    <br><small>运行时间</small>
                                </div>
                            </div>
                            <div class="col-4 text-right">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="card bg-info text-white mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                <div class="card-body-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="mr-5">
                                    <strong id="activeUsers">0</strong>
                                    <br><small>活跃用户</small>
                                </div>
                            </div>
                            <div class="col-4 text-right">
                                <i class="fas fa-users fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 详细监控信息 -->
        <div class="row">
            <!-- 系统信息 -->
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-info-circle"></i> 系统信息
                    </div>
                    <div class="card-body">
                        <div id="systemInfo">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p class="mt-2">正在获取系统信息...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- JVM信息 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-code"></i> JVM信息
                    </div>
                    <div class="card-body">
                        <div id="jvmInfo">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p class="mt-2">正在获取JVM信息...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 性能指标 -->
            <div class="col-lg-6">
                <!-- 数据库连接池 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-database"></i> 数据库连接池
                    </div>
                    <div class="card-body">
                        <div id="dbPoolInfo">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p class="mt-2">正在获取数据库信息...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API调用统计 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i> API调用统计
                    </div>
                    <div class="card-body">
                        <div id="apiStats">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p class="mt-2">正在获取API统计...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 实时监控控制 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-cogs"></i> 监控控制
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="realTimeMonitoring" checked>
                                    <label class="form-check-label" for="realTimeMonitoring">
                                        实时监控
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                    <label class="form-check-label" for="autoRefresh">
                                        自动刷新
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-primary" onclick="refreshAllMetrics()">
                                    <i class="fas fa-sync-alt"></i> 手动刷新
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-outline-danger" onclick="clearSystemCache()">
                                    <i class="fas fa-broom"></i> 清空缓存
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="scripts">
        <script>
            let monitoringInterval;

            // 刷新所有指标
            function refreshAllMetrics() {
                loadSystemInfo();
                loadJVMInfo();
                loadDBPoolInfo();
                loadAPIStats();
                updateOverviewCards();
            }

            // 加载系统信息
            function loadSystemInfo() {
                AdminAjax.get('/admin/api/monitor/system')
                    .then(function (response) {
                        if (response.code === 200) {
                            renderSystemInfo(response.data);
                        }
                    })
                    .catch(function (error) {
                        $('#systemInfo').html(`
                            <div class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                获取系统信息失败
                            </div>
                        `);
                    });
            }

            // 加载JVM信息
            function loadJVMInfo() {
                AdminAjax.get('/admin/api/monitor/jvm')
                    .then(function (response) {
                        if (response.code === 200) {
                            renderJVMInfo(response.data);
                        }
                    })
                    .catch(function (error) {
                        $('#jvmInfo').html(`
                            <div class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                获取JVM信息失败
                            </div>
                        `);
                    });
            }

            // 加载数据库连接池信息
            function loadDBPoolInfo() {
                AdminAjax.get('/admin/api/monitor/database')
                    .then(function (response) {
                        if (response.code === 200) {
                            renderDBPoolInfo(response.data);
                        }
                    })
                    .catch(function (error) {
                        $('#dbPoolInfo').html(`
                            <div class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                获取数据库信息失败
                            </div>
                        `);
                    });
            }

            // 加载API统计信息
            function loadAPIStats() {
                AdminAjax.get('/admin/api/monitor/api-stats')
                    .then(function (response) {
                        if (response.code === 200) {
                            renderAPIStats(response.data);
                        }
                    })
                    .catch(function (error) {
                        $('#apiStats').html(`
                            <div class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                获取API统计失败
                            </div>
                        `);
                    });
            }

            // 更新概览卡片
            function updateOverviewCards() {
                AdminAjax.get('/admin/api/monitor/overview')
                    .then(function (response) {
                        if (response.code === 200) {
                            const data = response.data;
                            $('#systemStatus').text(data.systemStatus || '正常');
                            $('#memoryUsage').text(data.memoryUsage + '%');
                            $('#uptime').text(formatUptime(data.uptime));
                            $('#activeUsers').text(data.activeUsers || 0);
                        }
                    })
                    .catch(function (error) {
                        console.error('更新概览卡片失败:', error);
                    });
            }

            // 渲染系统信息
            function renderSystemInfo(info) {
                const html = `
                    <div class="row">
                        <div class="col-6">
                            <strong>操作系统:</strong><br>
                            <small class="text-muted">${info.osName} ${info.osVersion}</small>
                        </div>
                        <div class="col-6">
                            <strong>处理器:</strong><br>
                            <small class="text-muted">${info.processor}</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <strong>总内存:</strong><br>
                            <small class="text-muted">${formatBytes(info.totalMemory)}</small>
                        </div>
                        <div class="col-6">
                            <strong>可用内存:</strong><br>
                            <small class="text-muted">${formatBytes(info.availableMemory)}</small>
                        </div>
                    </div>
                `;
                $('#systemInfo').html(html);
            }

            // 渲染JVM信息
            function renderJVMInfo(info) {
                const html = `
                    <div class="row">
                        <div class="col-6">
                            <strong>JVM版本:</strong><br>
                            <small class="text-muted">${info.version}</small>
                        </div>
                        <div class="col-6">
                            <strong>供应商:</strong><br>
                            <small class="text-muted">${info.vendor}</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <strong>堆内存:</strong><br>
                            <small class="text-muted">${formatBytes(info.heapUsed)} / ${formatBytes(info.heapMax)}</small>
                        </div>
                        <div class="col-6">
                            <strong>非堆内存:</strong><br>
                            <small class="text-muted">${formatBytes(info.nonHeapUsed)}</small>
                        </div>
                    </div>
                `;
                $('#jvmInfo').html(html);
            }

            // 渲染数据库连接池信息
            function renderDBPoolInfo(info) {
                const html = `
                    <div class="row">
                        <div class="col-6">
                            <strong>连接池类型:</strong><br>
                            <small class="text-muted">${info.poolType}</small>
                        </div>
                        <div class="col-6">
                            <strong>数据库:</strong><br>
                            <small class="text-muted">${info.database}</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <strong>活跃连接:</strong><br>
                            <small class="text-muted">${info.activeConnections}</small>
                        </div>
                        <div class="col-6">
                            <strong>空闲连接:</strong><br>
                            <small class="text-muted">${info.idleConnections}</small>
                        </div>
                    </div>
                `;
                $('#dbPoolInfo').html(html);
            }

            // 渲染API统计信息
            function renderAPIStats(stats) {
                const html = `
                    <div class="row">
                        <div class="col-6">
                            <strong>今日请求数:</strong><br>
                            <small class="text-muted">${stats.todayRequests || 0}</small>
                        </div>
                        <div class="col-6">
                            <strong>平均响应时间:</strong><br>
                            <small class="text-muted">${stats.avgResponseTime || 0}ms</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <strong>成功率:</strong><br>
                            <small class="text-muted">${stats.successRate || 100}%</small>
                        </div>
                        <div class="col-6">
                            <strong>错误率:</strong><br>
                            <small class="text-muted">${stats.errorRate || 0}%</small>
                        </div>
                    </div>
                `;
                $('#apiStats').html(html);
            }

            // 清空系统缓存
            function clearSystemCache() {
                if (confirm('确定要清空系统缓存吗？')) {
                    AdminAjax.post('/admin/api/monitor/clear-cache', {})
                        .then(function (response) {
                            AdminUtils.showMessage('系统缓存已清空', 'success');
                            refreshAllMetrics();
                        })
                        .catch(function (error) {
                            AdminUtils.showMessage('清空缓存失败: ' + error.responseJSON?.msg, 'error');
                        });
                }
            }

            // 格式化字节数
            function formatBytes(bytes) {
                if (!bytes) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // 格式化运行时间
            function formatUptime(uptime) {
                if (!uptime) return '0h 0m';
                const hours = Math.floor(uptime / (1000 * 60 * 60));
                const minutes = Math.floor((uptime % (1000 * 60 * 60)) / (1000 * 60));
                return `${hours}h ${minutes}m`;
            }

            // 启动实时监控
            function startRealTimeMonitoring() {
                monitoringInterval = setInterval(function () {
                    if ($('#autoRefresh').is(':checked')) {
                        refreshAllMetrics();
                    }
                }, 30000); // 每30秒刷新一次
            }

            // 停止实时监控
            function stopRealTimeMonitoring() {
                if (monitoringInterval) {
                    clearInterval(monitoringInterval);
                    monitoringInterval = null;
                }
            }

            // 实时监控开关
            $('#realTimeMonitoring').change(function () {
                if (this.checked) {
                    startRealTimeMonitoring();
                    AdminUtils.showMessage('实时监控已开启', 'success');
                } else {
                    stopRealTimeMonitoring();
                    AdminUtils.showMessage('实时监控已关闭', 'info');
                }
            });

            // 页面加载完成后的初始化
            $(document).ready(function () {
                // 检查并显示登录状态
                updatePageLoginStatus();

                // 加载所有监控数据
                refreshAllMetrics();

                // 启动实时监控
                startRealTimeMonitoring();
            });

            function updatePageLoginStatus() {
                // 检查token状态
                const token = AdminToken.getToken();
                const isLoggedIn = AdminToken.isLoggedIn();

                const statusDiv = $('#pageLoginStatus');
                const statusText = $('#pageStatusText');

                if (isLoggedIn && token) {
                    const prefix = token.substring(0, 10) + '...';
                    statusText.text(`已登录 (Token: ${prefix})`);
                    statusDiv.removeClass('alert-info alert-danger').addClass('alert-success');
                } else {
                    statusText.text('未登录状态');
                    statusDiv.removeClass('alert-info alert-success').addClass('alert-danger');
                }

                // 显示状态区域
                statusDiv.show();

                // 3秒后隐藏状态信息
                setTimeout(function () {
                    statusDiv.fadeOut();
                }, 3000);
            }
        </script>
    </div>
</body>

</html>
