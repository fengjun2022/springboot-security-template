<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org"
    th:replace="~{admin/layout :: layout(pageTitle=~{::title}, content=~{::#content}, scripts=~{::#scripts})}">

<head>
    <title>Token管理 - 权限管理系统</title>
</head>

<body>
    <div id="content">
        <!-- 登录状态显示 -->
        <div id="pageLoginStatus" class="alert alert-info mb-3" style="display: none;">
            <i class="fas fa-info-circle me-2"></i>
            <span id="pageStatusText">正在检查登录状态...</span>
        </div>

        <!-- 操作工具栏 -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-success" onclick="refreshAllTokens()">
                    <i class="fas fa-sync-alt"></i> 刷新所有Token
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="refreshTokenList()">
                    <i class="fas fa-refresh"></i> 刷新列表
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="clearExpiredTokens()">
                    <i class="fas fa-trash"></i> 清理过期Token
                </button>
            </div>

            <!-- 搜索框 -->
            <div class="input-group" style="width: 300px;">
                <input type="text" class="form-control" id="searchInput" placeholder="搜索应用ID...">
                <button class="btn btn-outline-secondary" type="button" onclick="searchTokens()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <!-- Token列表 -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-key"></i> 系统Token列表
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tokenTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll"></th>
                                <th>应用ID</th>
                                <th>应用名称</th>
                                <th>Token类型</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>过期时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="tokenTableBody">
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    正在加载Token列表...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Token详情模态框 -->
    <div class="modal fade" id="tokenDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Token详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="tokenDetailContent">
                        <!-- Token详情将在这里显示 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <div id="scripts">
        <script>
            let currentTokenData = [];

            // 刷新所有Token
            function refreshAllTokens() {
                if (confirm('确定要刷新所有应用的Token吗？此操作将使所有现有Token失效。')) {
                    AdminAjax.post('/admin/api/tokens/refresh-all', {})
                        .then(function (response) {
                            AdminUtils.showMessage('所有Token刷新完成', 'success');
                            refreshTokenList();
                        })
                        .catch(function (error) {
                            AdminUtils.showMessage('刷新失败: ' + error.responseJSON?.msg, 'error');
                        });
                }
            }

            // 刷新Token列表
            function refreshTokenList() {
                AdminAjax.get('/admin/api/tokens')
                    .then(function (response) {
                        if (response.code === 200) {
                            currentTokenData = response.data || [];
                            renderTokenTable(currentTokenData);
                        }
                    })
                    .catch(function (error) {
                        $('#tokenTableBody').html(`
                            <tr>
                                <td colspan="8" class="text-center text-danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    加载失败: ${error.responseJSON?.msg || '未知错误'}
                                </td>
                            </tr>
                        `);
                    });
            }

            // 清理过期Token
            function clearExpiredTokens() {
                if (confirm('确定要清理所有过期的Token吗？')) {
                    AdminAjax.delete('/admin/api/tokens/expired')
                        .then(function (response) {
                            AdminUtils.showMessage('过期Token清理完成', 'success');
                            refreshTokenList();
                        })
                        .catch(function (error) {
                            AdminUtils.showMessage('清理失败: ' + error.responseJSON?.msg, 'error');
                        });
                }
            }

            // 搜索Token
            function searchTokens() {
                const keyword = $('#searchInput').val().trim();
                if (keyword) {
                    const filteredData = currentTokenData.filter(token =>
                        token.appId.toLowerCase().includes(keyword.toLowerCase()) ||
                        token.appName.toLowerCase().includes(keyword.toLowerCase())
                    );
                    renderTokenTable(filteredData);
                } else {
                    renderTokenTable(currentTokenData);
                }
            }

            // 渲染Token表格
            function renderTokenTable(tokens) {
                if (!tokens || tokens.length === 0) {
                    $('#tokenTableBody').html(`
                        <tr>
                            <td colspan="8" class="text-center text-muted">
                                <i class="fas fa-info-circle me-2"></i>
                                暂无Token数据
                            </td>
                        </tr>
                    `);
                    return;
                }

                const html = tokens.map(token => `
                    <tr>
                        <td><input type="checkbox" class="token-checkbox" value="${token.id}"></td>
                        <td><code>${token.appId}</code></td>
                        <td>${token.appName || '未知应用'}</td>
                        <td>
                            <span class="badge ${token.type === 'service' ? 'bg-primary' : 'bg-info'}">
                                ${token.type === 'service' ? '服务Token' : '用户Token'}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${token.isValid === 1 ? 'bg-success' : 'bg-danger'}">
                                ${token.isValid === 1 ? '有效' : '无效'}
                            </span>
                        </td>
                        <td><small>${AdminUtils.formatDate(token.issueTime)}</small></td>
                        <td><small>${AdminUtils.formatDate(token.expireTime)}</small></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewTokenDetails('${token.id}')">
                                    <i class="fas fa-eye"></i> 详情
                                </button>
                                <button class="btn btn-outline-warning" onclick="refreshToken('${token.appId}')">
                                    <i class="fas fa-sync-alt"></i> 刷新
                                </button>
                                <button class="btn btn-outline-danger" onclick="invalidateToken('${token.id}')">
                                    <i class="fas fa-ban"></i> 作废
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                $('#tokenTableBody').html(html);
            }

            // 查看Token详情
            function viewTokenDetails(tokenId) {
                AdminAjax.get('/admin/api/tokens/' + tokenId)
                    .then(function (response) {
                        if (response.code === 200) {
                            const token = response.data;
                            const detailHtml = `
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>基本信息</h6>
                                        <p><strong>Token ID:</strong> <code>${token.id}</code></p>
                                        <p><strong>应用ID:</strong> <code>${token.appId}</code></p>
                                        <p><strong>应用名称:</strong> ${token.appName || '未知'}</p>
                                        <p><strong>类型:</strong> ${token.type === 'service' ? '服务Token' : '用户Token'}</p>
                                        <p><strong>状态:</strong> ${token.isValid === 1 ? '有效' : '无效'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>时间信息</h6>
                                        <p><strong>创建时间:</strong> ${AdminUtils.formatDate(token.issueTime)}</p>
                                        <p><strong>过期时间:</strong> ${AdminUtils.formatDate(token.expireTime)}</p>
                                        <p><strong>最后使用:</strong> ${AdminUtils.formatDate(token.lastUsedTime) || '从未使用'}</p>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <h6>Token值</h6>
                                    <div class="bg-light p-2 rounded">
                                        <small class="font-monospace">${token.tokenValue || 'Token值已隐藏'}</small>
                                    </div>
                                </div>
                            `;
                            $('#tokenDetailContent').html(detailHtml);
                            $('#tokenDetailModal').modal('show');
                        }
                    })
                    .catch(function (error) {
                        AdminUtils.showMessage('获取详情失败', 'error');
                    });
            }

            // 刷新单个应用的Token
            function refreshToken(appId) {
                if (confirm('确定要刷新该应用的Token吗？')) {
                    AdminAjax.post('/admin/api/tokens/refresh', { appId: appId })
                        .then(function (response) {
                            AdminUtils.showMessage('Token刷新成功', 'success');
                            refreshTokenList();
                        })
                        .catch(function (error) {
                            AdminUtils.showMessage('刷新失败: ' + error.responseJSON?.msg, 'error');
                        });
                }
            }

            // 作废Token
            function invalidateToken(tokenId) {
                if (confirm('确定要作废该Token吗？')) {
                    AdminAjax.put('/admin/api/tokens/' + tokenId + '/invalidate', {})
                        .then(function (response) {
                            AdminUtils.showMessage('Token已作废', 'success');
                            refreshTokenList();
                        })
                        .catch(function (error) {
                            AdminUtils.showMessage('作废失败: ' + error.responseJSON?.msg, 'error');
                        });
                }
            }

            // 全选功能
            $(document).on('change', '#selectAll', function () {
                $('.token-checkbox').prop('checked', this.checked);
            });

            // 页面加载完成后的初始化
            $(document).ready(function () {
                $('#searchInput').keypress(function (e) {
                    if (e.which === 13) {
                        searchTokens();
                    }
                });

                // 检查并显示登录状态
                updatePageLoginStatus();

                // 加载Token列表
                refreshTokenList();
            });

            function updatePageLoginStatus() {
                // 检查token状态
                const token = AdminToken.getToken();
                const isLoggedIn = AdminToken.isLoggedIn();

                const statusDiv = $('#pageLoginStatus');
                const statusText = $('#pageStatusText');

                if (isLoggedIn && token) {
                    const prefix = token.substring(0, 10) + '...';
                    statusText.text(`已登录 (Token: ${prefix})`);
                    statusDiv.removeClass('alert-info alert-danger').addClass('alert-success');
                } else {
                    statusText.text('未登录状态');
                    statusDiv.removeClass('alert-info alert-success').addClass('alert-danger');
                }

                // 显示状态区域
                statusDiv.show();

                // 3秒后隐藏状态信息
                setTimeout(function () {
                    statusDiv.fadeOut();
                }, 3000);
            }
        </script>
    </div>
</body>

</html>
