<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org"
    th:replace="~{admin/layout :: layout(pageTitle=~{::title}, content=~{::#content}, scripts=~{::#scripts})}">

<head>
    <title>应用管理 - 权限管理系统</title>
</head>

<body>
    <div id="content">
        <!-- 登录状态显示 -->
        <div id="pageLoginStatus" class="alert alert-info mb-3" style="display: none;">
            <i class="fas fa-info-circle me-2"></i>
            <span id="pageStatusText">正在检查登录状态...</span>
        </div>

        <!-- 操作工具栏 -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary" onclick="showCreateAppModal()">
                    <i class="fas fa-plus-circle"></i> 注册应用
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="refreshAppList()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
                <button type="button" class="btn btn-outline-info" onclick="batchRefreshTokens()">
                    <i class="fas fa-key"></i> 批量刷新Token
                </button>
            </div>

            <div class="input-group" style="width: 300px;">
                <input type="text" class="form-control" id="searchInput" placeholder="搜索应用...">
                <button class="btn btn-outline-secondary" type="button" onclick="searchApps()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <!-- 应用列表 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-mobile-alt"></i> 应用列表</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th width="5%">
                                    <input type="checkbox" id="selectAll" class="form-check-input">
                                </th>
                                <th>应用名称</th>
                                <th>应用ID</th>
                                <th>授权码</th>
                                <th>允许接口数</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="app : ${apps}">
                                <td>
                                    <input type="checkbox" class="form-check-input app-checkbox"
                                        th:value="${app.appId}">
                                </td>
                                <td>
                                    <i class="fas fa-mobile-alt text-primary"></i>
                                    <strong th:text="${app.appName}">测试应用</strong>
                                    <br><small class="text-muted" th:text="${app.remark}">应用描述</small>
                                </td>
                                <td>
                                    <code th:text="${app.appId}">713021225472069</code>
                                </td>
                                <td>
                                    <code class="text-truncate d-inline-block" style="max-width: 150px;"
                                        th:text="${app.authCode}" th:title="${app.authCode}">auth_code_xxx</code>
                                    <button class="btn btn-sm btn-outline-secondary ms-1"
                                        th:onclick="'copyToClipboard(\'' + ${app.authCode} + '\')'">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </td>
                                <td>
                                    <span class="badge bg-info" th:text="${#lists.size(app.allowedApiList)}">5</span>
                                    <button class="btn btn-sm btn-outline-info ms-1"
                                        th:onclick="'showAppPermissions(\'' + ${app.appId} + '\')'">
                                        <i class="fas fa-list"></i>
                                    </button>
                                </td>
                                <td>
                                    <span th:class="'badge bg-' + (${app.status == 1} ? 'success' : 'secondary')"
                                        th:text="${app.status == 1} ? '启用' : '禁用'">启用</span>
                                </td>
                                <td th:text="${#temporals.format(app.createTime, 'yyyy-MM-dd HH:mm')}">2025-01-27 10:30
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary"
                                            th:onclick="'editApp(\'' + ${app.appId} + '\')'">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-warning"
                                            th:onclick="'assignPermissions(\'' + ${app.appId} + '\')'">
                                            <i class="fas fa-shield-alt"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-success"
                                            th:onclick="'refreshToken(\'' + ${app.appId} + '\')'">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger"
                                            th:onclick="'toggleAppStatus(\'' + ${app.appId} + '\', ' + ${app.status} + ')'">
                                            <i th:class="${app.status == 1} ? 'fas fa-ban' : 'fas fa-check'"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/编辑应用模态框 -->
    <div class="modal fade" id="appModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="appModalTitle">注册应用</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="appForm">
                    <div class="modal-body">
                        <input type="hidden" id="appId" name="appId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="appName" class="form-label">应用名称 *</label>
                                    <input type="text" class="form-control" id="appName" name="appName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="appStatus" class="form-label">状态</label>
                                    <select class="form-select" id="appStatus" name="status">
                                        <option value="1">启用</option>
                                        <option value="0">禁用</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="allowedApis" class="form-label">允许的接口</label>
                            <div class="row">
                                <div class="col-md-8">
                                    <textarea class="form-control" id="allowedApis" name="allowedApis" rows="6"
                                        placeholder="输入允许访问的接口路径，每行一个，支持通配符，例如：&#10;/api/user/**&#10;/api/order/list&#10;/api/payment/**"></textarea>
                                </div>
                                <div class="col-md-4">
                                    <div class="border rounded p-2" style="height: 150px; overflow-y: auto;">
                                        <h6 class="text-muted">可选接口：</h6>
                                        <div id="availableEndpoints">
                                            <div th:each="endpoint : ${apiEndpoints}">
                                                <a href="javascript:void(0)" class="d-block text-decoration-none small"
                                                    th:onclick="'addEndpoint(\'' + ${endpoint.path} + '\')'">
                                                    <span
                                                        th:class="'badge bg-' + (${endpoint.method == 'GET'} ? 'success' : ${endpoint.method == 'POST'} ? 'primary' : 'warning') + ' me-1'"
                                                        th:text="${endpoint.method}">GET</span>
                                                    <span th:text="${endpoint.path}">/api/user/list</span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="appRemark" class="form-label">备注</label>
                            <textarea class="form-control" id="appRemark" name="remark" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 权限分配模态框 -->
    <div class="modal fade" id="permissionsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">权限分配</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="permissionAppId">
                    <p>为应用 <strong id="permissionAppName"></strong> 分配接口权限：</p>

                    <div class="row">
                        <div class="col-md-4">
                            <h6>模块分组</h6>
                            <div id="moduleGroups">
                                <!-- 模块分组将在这里动态加载 -->
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6>接口列表</h6>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                        onclick="selectAllEndpoints()">全选</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary"
                                        onclick="clearAllEndpoints()">清空</button>
                                </div>
                            </div>
                            <div id="endpointsList" style="height: 400px; overflow-y: auto;">
                                <!-- 接口列表将在这里动态加载 -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="savePermissions()">保存权限</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 应用详情模态框 -->
    <div class="modal fade" id="appDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">应用权限详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="appPermissionDetails">
                        <!-- 应用权限详情将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="scripts">
        <script>
            let isEditMode = false;
            let currentAppId = null;

            function showCreateAppModal() {
                isEditMode = false;
                $('#appModalTitle').text('注册应用');
                $('#appForm')[0].reset();
                $('#appId').val('');
                $('#appModal').modal('show');
            }

            function editApp(appId) {
                isEditMode = true;
                currentAppId = appId;
                $('#appModalTitle').text('编辑应用');

                // 这里应该通过AJAX获取应用详情
                $('#appId').val(appId);
                $('#appModal').modal('show');
            }

            function assignPermissions(appId) {
                currentAppId = appId;
                $('#permissionAppId').val(appId);

                // 加载模块分组和接口列表
                loadModuleGroups();
                loadEndpointsList();

                $('#permissionsModal').modal('show');
            }

            function refreshToken(appId) {
                if (confirm('确定要刷新该应用的Token吗？刷新后旧Token将失效。')) {
                    $.ajax({
                        url: `/admin/api/apps/${appId}/refresh-token`,
                        method: 'POST',
                        success: function (response) {
                            alert('Token刷新成功！');
                            // 显示新Token
                            showTokenInfo(response.data);
                        },
                        error: function () {
                            alert('Token刷新失败');
                        }
                    });
                }
            }

            function showTokenInfo(token) {
                const tokenInfo = `
                    <div class="alert alert-success">
                        <h6>新Token已生成：</h6>
                        <div class="input-group">
                            <input type="text" class="form-control" value="${token.token}" readonly>
                            <button class="btn btn-outline-secondary" onclick="copyToClipboard('${token.token}')">
                                <i class="fas fa-copy"></i> 复制
                            </button>
                        </div>
                        <small class="text-muted">请妥善保存此Token，页面刷新后将不再显示完整Token。</small>
                    </div>
                `;

                // 可以使用模态框或其他方式显示Token信息
                alert('Token刷新成功，请在控制台或专门的Token管理页面查看完整Token。');
            }

            function toggleAppStatus(appId, currentStatus) {
                const action = currentStatus === 1 ? '禁用' : '启用';
                if (confirm(`确定要${action}该应用吗？`)) {
                    $.ajax({
                        url: `/admin/api/apps/${appId}/status`,
                        method: 'PUT',
                        data: { status: currentStatus === 1 ? 0 : 1 },
                        success: function (response) {
                            alert(response.msg);
                            refreshAppList();
                        },
                        error: function () {
                            alert(`${action}应用失败`);
                        }
                    });
                }
            }

            function showAppPermissions(appId) {
                // 显示应用当前权限详情
                $.get(`/admin/api/apps/${appId}/permissions`)
                    .done(function (response) {
                        if (response.code === 200) {
                            renderAppPermissions(response.data);
                            $('#appDetailsModal').modal('show');
                        }
                    })
                    .fail(function () {
                        alert('获取应用权限失败');
                    });
            }

            function renderAppPermissions(permissions) {
                let html = '<div class="row">';
                permissions.forEach(function (permission) {
                    html += `
                        <div class="col-md-6 mb-2">
                            <span class="badge bg-${getMethodColor(permission.method)} me-1">${permission.method}</span>
                            <code>${permission.path}</code>
                        </div>
                    `;
                });
                html += '</div>';
                $('#appPermissionDetails').html(html);
            }

            function getMethodColor(method) {
                const colors = {
                    'GET': 'success',
                    'POST': 'primary',
                    'PUT': 'warning',
                    'DELETE': 'danger',
                    'PATCH': 'info'
                };
                return colors[method] || 'secondary';
            }

            function addEndpoint(path) {
                const currentApis = $('#allowedApis').val();
                const newApis = currentApis ? currentApis + '\n' + path : path;
                $('#allowedApis').val(newApis);
            }

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(function () {
                    alert('已复制到剪贴板');
                }).catch(function () {
                    alert('复制失败');
                });
            }

            function refreshAppList() {
                location.reload();
            }

            function searchApps() {
                const keyword = $('#searchInput').val();
                console.log('搜索关键词:', keyword);
            }

            function batchRefreshTokens() {
                const selectedApps = $('.app-checkbox:checked').map(function () {
                    return this.value;
                }).get();

                if (selectedApps.length === 0) {
                    alert('请选择要刷新Token的应用');
                    return;
                }

                if (confirm(`确定要刷新选中的 ${selectedApps.length} 个应用的Token吗？`)) {
                    // 批量刷新Token
                    console.log('批量刷新Token:', selectedApps);
                }
            }

            function loadModuleGroups() {
                // 加载模块分组
                $('#moduleGroups').html('<p class="text-muted">加载中...</p>');
            }

            function loadEndpointsList() {
                // 加载接口列表
                $('#endpointsList').html('<p class="text-muted">加载中...</p>');
            }

            function selectAllEndpoints() {
                $('.endpoint-checkbox').prop('checked', true);
            }

            function clearAllEndpoints() {
                $('.endpoint-checkbox').prop('checked', false);
            }

            function savePermissions() {
                const selectedEndpoints = $('.endpoint-checkbox:checked').map(function () {
                    return this.value;
                }).get();

                $.ajax({
                    url: `/admin/api/apps/${currentAppId}/permissions`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(selectedEndpoints),
                    success: function (response) {
                        alert(response.msg);
                        $('#permissionsModal').modal('hide');
                        refreshAppList();
                    },
                    error: function () {
                        alert('权限分配失败');
                    }
                });
            }

            // 表单提交处理
            $('#appForm').submit(function (e) {
                e.preventDefault();

                const allowedApis = $('#allowedApis').val().split('\n').filter(api => api.trim());

                const formData = {
                    appName: $('#appName').val(),
                    allowedApis: allowedApis,
                    status: $('#appStatus').val(),
                    remark: $('#appRemark').val()
                };

                const url = isEditMode ? `/admin/api/apps/${$('#appId').val()}` : '/admin/api/apps';
                const method = isEditMode ? 'PUT' : 'POST';

                $.ajax({
                    url: url,
                    method: method,
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        alert(response.msg);
                        $('#appModal').modal('hide');
                        refreshAppList();
                    },
                    error: function () {
                        alert(`${isEditMode ? '更新' : '创建'}应用失败`);
                    }
                });
            });

            // 全选功能
            $('#selectAll').change(function () {
                $('.app-checkbox').prop('checked', this.checked);
            });

            // 页面加载完成后的初始化
            $(document).ready(function () {
                $('#searchInput').keypress(function (e) {
                    if (e.which === 13) {
                        searchApps();
                    }
                });

                // 检查并显示登录状态
                updatePageLoginStatus();
            });

            function updatePageLoginStatus() {
                // 检查token状态
                const token = AdminToken.getToken();
                const isLoggedIn = AdminToken.isLoggedIn();

                const statusDiv = $('#pageLoginStatus');
                const statusText = $('#pageStatusText');

                if (isLoggedIn && token) {
                    const prefix = token.substring(0, 10) + '...';
                    statusText.text(`已登录 (Token: ${prefix})`);
                    statusDiv.removeClass('alert-info alert-danger').addClass('alert-success');
                } else {
                    statusText.text('未登录状态');
                    statusDiv.removeClass('alert-info alert-success').addClass('alert-danger');
                }

                // 显示状态区域
                statusDiv.show();

                // 3秒后隐藏状态信息
                setTimeout(function () {
                    statusDiv.fadeOut();
                }, 3000);
            }
        </script>
    </div>
</body>

</html>