<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org"
    th:replace="~{admin/layout :: layout(pageTitle=~{::title}, content=~{::#content}, scripts=~{::#scripts})}">

<head>
    <title>系统概览 - 权限管理系统</title>
</head>

<body>
    <div id="content">
        <!-- 统计卡片 -->
        <div class="row">
            <div class="col-xl-3 col-md-6">
                <div class="card bg-primary text-white mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                <div class="card-body-icon">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                                <div class="mr-5">
                                    <strong th:text="${stats.totalUsers ?: 0}">0</strong> 用户
                                    <br><small th:text="'活跃: ' + (${stats.activeUsers} ?: 0)">活跃: 0</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <a class="card-footer text-white clearfix small z-1" href="/admin/users">
                        <span class="float-left">查看详情</span>
                        <span class="float-right"><i class="fas fa-angle-right"></i></span>
                    </a>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="card bg-success text-white mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                <div class="card-body-icon">
                                    <i class="fas fa-mobile-alt fa-2x"></i>
                                </div>
                                <div class="mr-5">
                                    <strong th:text="${stats.totalApps ?: 0}">0</strong> 应用
                                    <br><small th:text="'激活: ' + (${stats.activeApps} ?: 0)">激活: 0</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <a class="card-footer text-white clearfix small z-1" href="/admin/apps">
                        <span class="float-left">查看详情</span>
                        <span class="float-right"><i class="fas fa-angle-right"></i></span>
                    </a>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="card bg-warning text-white mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                <div class="card-body-icon">
                                    <i class="fas fa-code fa-2x"></i>
                                </div>
                                <div class="mr-5">
                                    <strong th:text="${stats.totalEndpoints ?: 0}">0</strong> 接口
                                    <br><small th:text="'启用: ' + (${stats.activeEndpoints} ?: 0)">启用: 0</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <a class="card-footer text-white clearfix small z-1" href="/admin/endpoints">
                        <span class="float-left">查看详情</span>
                        <span class="float-right"><i class="fas fa-angle-right"></i></span>
                    </a>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="card bg-info text-white mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                <div class="card-body-icon">
                                    <i class="fas fa-key fa-2x"></i>
                                </div>
                                <div class="mr-5">
                                    <strong th:text="${stats.totalTokens ?: 0}">0</strong> Token
                                    <br><small th:text="'有效: ' + (${stats.validTokens} ?: 0)">有效: 0</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <a class="card-footer text-white clearfix small z-1" href="/admin/tokens">
                        <span class="float-left">查看详情</span>
                        <span class="float-right"><i class="fas fa-angle-right"></i></span>
                    </a>
                </div>
            </div>
        </div>

        <!-- 快速操作面板 -->
        <div class="row">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-bolt"></i> 快速操作
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <button class="btn btn-outline-primary btn-lg w-100" onclick="showCreateUserModal()">
                                    <i class="fas fa-user-plus"></i><br>新增用户
                                </button>
                            </div>
                            <div class="col-md-6 mb-3">
                                <button class="btn btn-outline-success btn-lg w-100" onclick="showCreateAppModal()">
                                    <i class="fas fa-plus-circle"></i><br>注册应用
                                </button>
                            </div>
                            <div class="col-md-6 mb-3">
                                <button class="btn btn-outline-warning btn-lg w-100" onclick="scanEndpoints()">
                                    <i class="fas fa-search"></i><br>扫描接口
                                </button>
                            </div>
                            <div class="col-md-6 mb-3">
                                <button class="btn btn-outline-info btn-lg w-100" onclick="refreshAllCache()">
                                    <i class="fas fa-sync-alt"></i><br>刷新缓存
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-chart-pie"></i> 系统状态
                    </div>
                    <div class="card-body">
                        <div id="loginStatus" class="mb-3 p-2 bg-light rounded">
                            <small class="text-muted">
                                <i class="fas fa-user-circle"></i>
                                <span id="currentUserStatus">检查登录状态...</span>
                            </small>
                        </div>
                        <div id="systemStatus">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p class="mt-2">正在获取系统状态...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 最新活动 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-history"></i> 最新活动
                    </div>
                    <div class="card-body">
                        <div id="recentActivities">
                            <div class="text-center">
                                <p class="text-muted">正在加载最新活动...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增用户模态框 -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="createUserForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="username" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">密码</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">邮箱</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                        <div class="mb-3">
                            <label for="roles" class="form-label">角色</label>
                            <select class="form-select" id="roles" name="roles" multiple>
                                <option value="ADMIN">管理员</option>
                                <option value="MANAGER">经理</option>
                                <option value="USER">用户</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">创建用户</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 新增应用模态框 -->
    <div class="modal fade" id="createAppModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">注册应用</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="createAppForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="appName" class="form-label">应用名称</label>
                            <input type="text" class="form-control" id="appName" name="appName" required>
                        </div>
                        <div class="mb-3">
                            <label for="allowedApis" class="form-label">允许的接口</label>
                            <textarea class="form-control" id="allowedApis" name="allowedApis" rows="4"
                                placeholder="输入允许访问的接口路径，每行一个，例如：&#10;/api/user/**&#10;/api/order/**"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="appRemark" class="form-label">备注</label>
                            <input type="text" class="form-control" id="appRemark" name="remark">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-success">注册应用</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="scripts">
        <script>
            $(document).ready(function () {
                loadSystemStatus();
                loadRecentActivities();
                updateLoginStatus();

                // 定时刷新状态（每30秒）
                setInterval(loadSystemStatus, 30000);
            });

            function updateLoginStatus() {
                // 检查token状态
                const token = AdminToken.getToken();
                const isLoggedIn = AdminToken.isLoggedIn();

                let statusText = '未登录';
                let statusClass = 'text-danger';

                if (isLoggedIn && token) {
                    statusText = '已登录';
                    statusClass = 'text-success';

                    // 如果token存在，显示前缀
                    const prefix = token.substring(0, 10) + '...';
                    statusText += ` (${prefix})`;
                }

                $('#currentUserStatus').text(statusText).removeClass('text-danger text-success').addClass(statusClass);
            }

            function loadSystemStatus() {
                $.get('/admin/api/system/status')
                    .done(function (response) {
                        if (response.code === 200) {
                            renderSystemStatus(response.data);
                        }
                    })
                    .fail(function () {
                        $('#systemStatus').html('<p class="text-danger">获取系统状态失败</p>');
                    });
            }

            function renderSystemStatus(status) {
                const html = `
                    <div class="status-item">
                        <i class="fas fa-database text-success"></i>
                        <span>数据库: ${status.databaseStatus}</span>
                    </div>
                    <div class="status-item mt-2">
                        <i class="fas fa-memory text-info"></i>
                        <span>内存使用: ${status.memoryUsage?.toFixed(1)}%</span>
                    </div>
                    <div class="status-item mt-2">
                        <i class="fas fa-clock text-warning"></i>
                        <span>运行时间: ${formatUptime(status.uptime)}</span>
                    </div>
                `;
                $('#systemStatus').html(html);
            }

            function formatUptime(uptime) {
                const hours = Math.floor(uptime / (1000 * 60 * 60));
                const minutes = Math.floor((uptime % (1000 * 60 * 60)) / (1000 * 60));
                return `${hours}小时${minutes}分钟`;
            }

            function loadRecentActivities() {
                // 这里可以加载最新的系统活动日志
                setTimeout(function () {
                    $('#recentActivities').html('<p class="text-muted">暂无最新活动</p>');
                }, 1000);
            }

            function showCreateUserModal() {
                $('#createUserModal').modal('show');
            }

            function showCreateAppModal() {
                $('#createAppModal').modal('show');
            }

            function scanEndpoints() {
                if (confirm('确定要扫描系统接口吗？')) {
                    $.post('/admin/api/endpoints/scan')
                        .done(function (response) {
                            alert(response.msg);
                            location.reload();
                        })
                        .fail(function () {
                            alert('扫描失败');
                        });
                }
            }

            function refreshAllCache() {
                if (confirm('确定要刷新所有缓存吗？')) {
                    $.post('/admin/api/system/clear-cache')
                        .done(function (response) {
                            alert(response.msg);
                        })
                        .fail(function () {
                            alert('刷新缓存失败');
                        });
                }
            }

            // 表单提交处理
            $('#createUserForm').submit(function (e) {
                e.preventDefault();

                const formData = {
                    username: $('#username').val(),
                    password: $('#password').val(),
                    email: $('#email').val(),
                    roles: $('#roles').val() || []
                };

                $.ajax({
                    url: '/admin/api/users',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        alert(response.msg);
                        $('#createUserModal').modal('hide');
                        location.reload();
                    },
                    error: function () {
                        alert('创建用户失败');
                    }
                });
            });

            $('#createAppForm').submit(function (e) {
                e.preventDefault();

                const allowedApis = $('#allowedApis').val().split('\n').filter(api => api.trim());

                const formData = {
                    appName: $('#appName').val(),
                    allowedApis: allowedApis,
                    remark: $('#appRemark').val()
                };

                $.ajax({
                    url: '/admin/api/apps',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        alert('应用注册成功');
                        $('#createAppModal').modal('hide');
                        location.reload();
                    },
                    error: function () {
                        alert('注册应用失败');
                    }
                });
            });
        </script>
    </div>
</body>

</html>