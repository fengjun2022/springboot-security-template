<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org"
    th:replace="~{admin/layout :: layout(pageTitle=~{::title}, content=~{::#content}, scripts=~{::#scripts})}">

<head>
    <title>接口管理 - 权限管理系统</title>
</head>

<body>
    <div id="content">
        <!-- 登录状态显示 -->
        <div id="pageLoginStatus" class="alert alert-info mb-3" style="display: none;">
            <i class="fas fa-info-circle me-2"></i>
            <span id="pageStatusText">正在检查登录状态...</span>
        </div>

        <!-- 操作工具栏 -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary" onclick="scanEndpoints()">
                    <i class="fas fa-search"></i> 扫描接口
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="refreshEndpointList()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>

            <!-- 搜索框 -->
            <div class="input-group" style="width: 300px;">
                <input type="text" class="form-control" id="searchInput" placeholder="搜索接口路径...">
                <button class="btn btn-outline-secondary" type="button" onclick="searchEndpoints()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <!-- 接口列表 -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-code"></i> 系统接口列表
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="endpointTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll"></th>
                                <th>接口路径</th>
                                <th>HTTP方法</th>
                                <th>控制器类</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="endpointTableBody">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    正在加载接口列表...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="scripts">
        <script>
            let currentEndpointData = [];

            // 扫描接口
            function scanEndpoints() {
                if (confirm('确定要扫描系统接口吗？此操作可能会需要一些时间。')) {
                    AdminAjax.post('/admin/api/endpoints/scan', {})
                        .then(function (response) {
                            AdminUtils.showMessage('扫描完成，共发现 ' + (response.data ? response.data.length : 0) + ' 个接口', 'success');
                            refreshEndpointList();
                        })
                        .catch(function (error) {
                            AdminUtils.showMessage('扫描失败: ' + error.responseJSON?.msg, 'error');
                        });
                }
            }

            // 刷新接口列表
            function refreshEndpointList() {
                AdminAjax.get('/admin/api/endpoints')
                    .then(function (response) {
                        if (response.code === 200) {
                            currentEndpointData = response.data || [];
                            renderEndpointTable(currentEndpointData);
                        }
                    })
                    .catch(function (error) {
                        $('#endpointTableBody').html(`
                            <tr>
                                <td colspan="7" class="text-center text-danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    加载失败: ${error.responseJSON?.msg || '未知错误'}
                                </td>
                            </tr>
                        `);
                    });
            }

            // 搜索接口
            function searchEndpoints() {
                const keyword = $('#searchInput').val().trim();
                if (keyword) {
                    const filteredData = currentEndpointData.filter(endpoint =>
                        endpoint.path.toLowerCase().includes(keyword.toLowerCase()) ||
                        endpoint.controllerClass.toLowerCase().includes(keyword.toLowerCase())
                    );
                    renderEndpointTable(filteredData);
                } else {
                    renderEndpointTable(currentEndpointData);
                }
            }

            // 渲染接口表格
            function renderEndpointTable(endpoints) {
                if (!endpoints || endpoints.length === 0) {
                    $('#endpointTableBody').html(`
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <i class="fas fa-info-circle me-2"></i>
                                暂无接口数据
                            </td>
                        </tr>
                    `);
                    return;
                }

                const html = endpoints.map(endpoint => `
                    <tr>
                        <td><input type="checkbox" class="endpoint-checkbox" value="${endpoint.id}"></td>
                        <td><code>${endpoint.path}</code></td>
                        <td><span class="badge bg-primary">${endpoint.method || 'ALL'}</span></td>
                        <td><small class="text-muted">${endpoint.controllerClass}</small></td>
                        <td>
                            <span class="badge ${endpoint.status === 1 ? 'bg-success' : 'bg-secondary'}">
                                ${endpoint.status === 1 ? '启用' : '禁用'}
                            </span>
                        </td>
                        <td><small>${AdminUtils.formatDate(endpoint.createTime)}</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewEndpointDetails(${endpoint.id})">
                                <i class="fas fa-eye"></i> 详情
                            </button>
                        </td>
                    </tr>
                `).join('');

                $('#endpointTableBody').html(html);
            }

            // 查看接口详情
            function viewEndpointDetails(endpointId) {
                AdminUtils.showMessage('详情功能开发中...', 'info');
            }

            // 全选功能
            $(document).on('change', '#selectAll', function () {
                $('.endpoint-checkbox').prop('checked', this.checked);
            });

            // 页面加载完成后的初始化
            $(document).ready(function () {
                $('#searchInput').keypress(function (e) {
                    if (e.which === 13) {
                        searchEndpoints();
                    }
                });

                // 检查并显示登录状态
                updatePageLoginStatus();

                // 加载接口列表
                refreshEndpointList();
            });

            function updatePageLoginStatus() {
                // 检查token状态
                const token = AdminToken.getToken();
                const isLoggedIn = AdminToken.isLoggedIn();

                const statusDiv = $('#pageLoginStatus');
                const statusText = $('#pageStatusText');

                if (isLoggedIn && token) {
                    const prefix = token.substring(0, 10) + '...';
                    statusText.text(`已登录 (Token: ${prefix})`);
                    statusDiv.removeClass('alert-info alert-danger').addClass('alert-success');
                } else {
                    statusText.text('未登录状态');
                    statusDiv.removeClass('alert-info alert-success').addClass('alert-danger');
                }

                // 显示状态区域
                statusDiv.show();

                // 3秒后隐藏状态信息
                setTimeout(function () {
                    statusDiv.fadeOut();
                }, 3000);
            }
        </script>
    </div>
</body>

</html>
