<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org"
    th:replace="~{admin/layout :: layout(pageTitle=~{::title}, content=~{::#content}, scripts=~{::#scripts})}">

<head>
    <title>权限分配 - 权限管理系统</title>
</head>

<body>
    <div id="content">
        <!-- 登录状态显示 -->
        <div id="pageLoginStatus" class="alert alert-info mb-3" style="display: none;">
            <i class="fas fa-info-circle me-2"></i>
            <span id="pageStatusText">正在检查登录状态...</span>
        </div>

        <!-- 操作工具栏 -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary" onclick="assignPermissions()">
                    <i class="fas fa-user-shield"></i> 分配权限
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="refreshPermissions()">
                    <i class="fas fa-refresh"></i> 刷新
                </button>
            </div>

            <!-- 搜索框 -->
            <div class="input-group" style="width: 300px;">
                <input type="text" class="form-control" id="searchInput" placeholder="搜索应用或接口...">
                <button class="btn btn-outline-secondary" type="button" onclick="searchPermissions()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <!-- 权限分配面板 -->
        <div class="row">
            <!-- 应用列表 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-mobile-alt"></i> 应用列表
                    </div>
                    <div class="card-body">
                        <div class="list-group" id="appList">
                            <div class="text-center text-muted">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                正在加载应用列表...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 接口权限 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-code"></i> 接口权限
                        <small class="text-muted ms-2" id="selectedAppInfo">请选择应用</small>
                    </div>
                    <div class="card-body">
                        <div id="permissionList">
                            <div class="text-center text-muted">
                                <i class="fas fa-arrow-left fa-2x mb-2"></i>
                                <p>请先选择一个应用</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 权限分配模态框 -->
    <div class="modal fade" id="permissionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">分配权限</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>选择应用</h6>
                            <div id="appSelectionList">
                                <!-- 应用列表 -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>选择接口</h6>
                            <div id="endpointSelectionList">
                                <!-- 接口列表 -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="savePermissions()">保存权限</button>
                </div>
            </div>
        </div>
    </div>

    <div id="scripts">
        <script>
            let currentAppData = [];
            let currentEndpointData = [];
            let selectedAppId = null;

            // 刷新权限数据
            function refreshPermissions() {
                loadAppList();
                loadEndpointList();
            }

            // 加载应用列表
            function loadAppList() {
                AdminAjax.get('/admin/api/apps')
                    .then(function (response) {
                        if (response.code === 200) {
                            currentAppData = response.data || [];
                            renderAppList(currentAppData);
                        }
                    })
                    .catch(function (error) {
                        $('#appList').html(`
                            <div class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                加载应用列表失败
                            </div>
                        `);
                    });
            }

            // 加载接口列表
            function loadEndpointList() {
                AdminAjax.get('/admin/api/endpoints')
                    .then(function (response) {
                        if (response.code === 200) {
                            currentEndpointData = response.data || [];
                        }
                    })
                    .catch(function (error) {
                        console.error('加载接口列表失败:', error);
                    });
            }

            // 渲染应用列表
            function renderAppList(apps) {
                if (!apps || apps.length === 0) {
                    $('#appList').html(`
                        <div class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            暂无应用数据
                        </div>
                    `);
                    return;
                }

                const html = apps.map(app => `
                    <a href="#" class="list-group-item list-group-item-action app-item"
                       onclick="selectApp('${app.appId}', '${app.appName}')">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${app.appName}</h6>
                            <small class="text-muted">${app.appId}</small>
                        </div>
                        <p class="mb-1">${app.allowedApis ? app.allowedApis.length : 0} 个接口权限</p>
                        <small class="text-${app.status === 1 ? 'success' : 'danger'}">
                            ${app.status === 1 ? '启用' : '禁用'}
                        </small>
                    </a>
                `).join('');

                $('#appList').html(html);

                // 如果有选中的应用，保持选中状态
                if (selectedAppId) {
                    $(`.app-item[data-app-id="${selectedAppId}"]`).addClass('active');
                }
            }

            // 选择应用
            function selectApp(appId, appName) {
                selectedAppId = appId;

                // 更新UI
                $('.app-item').removeClass('active');
                $(`.app-item:contains("${appName}")`).addClass('active');

                // 更新标题
                $('#selectedAppInfo').text(`应用: ${appName} (${appId})`);

                // 加载该应用的权限
                loadAppPermissions(appId);
            }

            // 加载应用权限
            function loadAppPermissions(appId) {
                AdminAjax.get('/admin/api/apps/' + appId + '/permissions')
                    .then(function (response) {
                        if (response.code === 200) {
                            renderAppPermissions(response.data);
                        }
                    })
                    .catch(function (error) {
                        $('#permissionList').html(`
                            <div class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                加载权限失败
                            </div>
                        `);
                    });
            }

            // 渲染应用权限
            function renderAppPermissions(permissions) {
                if (!permissions || permissions.length === 0) {
                    $('#permissionList').html(`
                        <div class="text-center text-muted">
                            <i class="fas fa-ban me-2"></i>
                            该应用暂无接口权限
                        </div>
                    `);
                    return;
                }

                const html = permissions.map(permission => `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <div>
                            <code class="me-2">${permission.endpoint.path}</code>
                            <span class="badge bg-primary">${permission.endpoint.method}</span>
                        </div>
                        <div>
                            <span class="badge bg-${permission.hasPermission ? 'success' : 'secondary'}">
                                ${permission.hasPermission ? '已授权' : '未授权'}
                            </span>
                        </div>
                    </div>
                `).join('');

                $('#permissionList').html(html);
            }

            // 分配权限
            function assignPermissions() {
                // 构建应用选择列表
                const appOptions = currentAppData.map(app => `
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="selectedApp" value="${app.appId}" id="app_${app.appId}">
                        <label class="form-check-label" for="app_${app.appId}">
                            <strong>${app.appName}</strong><br>
                            <small class="text-muted">${app.appId}</small>
                        </label>
                    </div>
                `).join('');

                // 构建接口选择列表
                const endpointOptions = currentEndpointData.map(endpoint => `
                    <div class="form-check">
                        <input class="form-check-input permission-checkbox" type="checkbox" value="${endpoint.id}" id="endpoint_${endpoint.id}">
                        <label class="form-check-label" for="endpoint_${endpoint.id}">
                            <code>${endpoint.path}</code><br>
                            <small class="text-muted">${endpoint.controllerClass}</small>
                        </label>
                    </div>
                `).join('');

                $('#appSelectionList').html(appOptions);
                $('#endpointSelectionList').html(endpointOptions);

                $('#permissionModal').modal('show');
            }

            // 保存权限
            function savePermissions() {
                const selectedApp = $('input[name="selectedApp"]:checked').val();
                const selectedEndpoints = $('.permission-checkbox:checked').map(function () {
                    return this.value;
                }).get();

                if (!selectedApp) {
                    AdminUtils.showMessage('请选择一个应用', 'warning');
                    return;
                }

                if (selectedEndpoints.length === 0) {
                    AdminUtils.showMessage('请至少选择一个接口', 'warning');
                    return;
                }

                const permissionData = {
                    appId: selectedApp,
                    endpointIds: selectedEndpoints
                };

                AdminAjax.post('/admin/api/permissions/assign', permissionData)
                    .then(function (response) {
                        AdminUtils.showMessage('权限分配成功', 'success');
                        $('#permissionModal').modal('hide');

                        // 如果当前选中的应用就是分配的应用，刷新权限
                        if (selectedApp === selectedAppId) {
                            loadAppPermissions(selectedAppId);
                        }
                    })
                    .catch(function (error) {
                        AdminUtils.showMessage('权限分配失败: ' + error.responseJSON?.msg, 'error');
                    });
            }

            // 搜索权限
            function searchPermissions() {
                const keyword = $('#searchInput').val().trim();
                if (keyword) {
                    const filteredApps = currentAppData.filter(app =>
                        app.appName.toLowerCase().includes(keyword.toLowerCase()) ||
                        app.appId.toLowerCase().includes(keyword.toLowerCase())
                    );
                    renderAppList(filteredApps);
                } else {
                    renderAppList(currentAppData);
                }
            }

            // 页面加载完成后的初始化
            $(document).ready(function () {
                $('#searchInput').keypress(function (e) {
                    if (e.which === 13) {
                        searchPermissions();
                    }
                });

                // 检查并显示登录状态
                updatePageLoginStatus();

                // 加载数据
                refreshPermissions();
            });

            function updatePageLoginStatus() {
                // 检查token状态
                const token = AdminToken.getToken();
                const isLoggedIn = AdminToken.isLoggedIn();

                const statusDiv = $('#pageLoginStatus');
                const statusText = $('#pageStatusText');

                if (isLoggedIn && token) {
                    const prefix = token.substring(0, 10) + '...';
                    statusText.text(`已登录 (Token: ${prefix})`);
                    statusDiv.removeClass('alert-info alert-danger').addClass('alert-success');
                } else {
                    statusText.text('未登录状态');
                    statusDiv.removeClass('alert-info alert-success').addClass('alert-danger');
                }

                // 显示状态区域
                statusDiv.show();

                // 3秒后隐藏状态信息
                setTimeout(function () {
                    statusDiv.fadeOut();
                }, 3000);
            }
        </script>
    </div>
</body>

</html>
