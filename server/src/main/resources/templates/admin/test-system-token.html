<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿå±‚é¢Tokenæµ‹è¯• - æƒé™ç®¡ç†ç³»ç»Ÿ</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- è‡ªå®šä¹‰CSS -->
    <link href="/css/admin.css" rel="stylesheet">
</head>

<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-shield-alt me-2"></i>
                            ç³»ç»Ÿå±‚é¢Tokenè‡ªåŠ¨è·å–æµ‹è¯•
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>æµ‹è¯•è¯´æ˜</h6>
                            <p class="mb-0">
                                è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•ç³»ç»Ÿå±‚é¢çš„Tokenè‡ªåŠ¨è·å–åŠŸèƒ½ã€‚TokenAutoHeaderFilterä¼šè‡ªåŠ¨ä»Cookieä¸­è·å–tokenå¹¶è®¾ç½®åˆ°è¯·æ±‚å¤´ä¸­ã€‚
                            </p>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <h5><i class="fas fa-cookie-bite me-2"></i>TokençŠ¶æ€</h5>
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text">localStorage</span>
                                        <input type="text" class="form-control" id="localStorageToken" readonly>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text">Cookie</span>
                                        <input type="text" class="form-control" id="cookieToken" readonly>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text">ç™»å½•çŠ¶æ€</span>
                                        <input type="text" class="form-control" id="loginStatus" readonly>
                                    </div>
                                </div>
                                <button class="btn btn-outline-primary" onclick="refreshTokenStatus()">
                                    <i class="fas fa-sync-alt me-2"></i>åˆ·æ–°çŠ¶æ€
                                </button>
                            </div>

                            <div class="col-md-6">
                                <h5><i class="fas fa-network-wired me-2"></i>APIæµ‹è¯•</h5>
                                <div class="mb-3">
                                    <button class="btn btn-outline-success btn-sm" onclick="testApiWithoutToken()">
                                        <i class="fas fa-play me-1"></i>æµ‹è¯•æ— tokenè¯·æ±‚
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="testApiWithToken()">
                                        <i class="fas fa-play me-1"></i>æµ‹è¯•ç³»ç»Ÿè‡ªåŠ¨token
                                    </button>
                                </div>
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text">å“åº”çŠ¶æ€</span>
                                        <input type="text" class="form-control" id="apiResponseStatus" readonly>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">APIå“åº”å†…å®¹</label>
                                    <textarea class="form-control" id="apiResponseContent" rows="6" readonly></textarea>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="row">
                            <div class="col-12">
                                <h5><i class="fas fa-terminal me-2"></i>æ“ä½œæ—¥å¿—</h5>
                                <div id="operationLog" class="bg-dark text-light p-3"
                                    style="height: 300px; overflow-y: auto; font-family: monospace;">
                                    <div>ç­‰å¾…æ“ä½œ...</div>
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                                        <i class="fas fa-trash me-1"></i>æ¸…ç©ºæ—¥å¿—
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-bottom">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-shield-alt me-2"></i>
                Tokenè‡ªåŠ¨è·å–æµ‹è¯•
            </span>
            <div class="d-flex">
                <a href="/admin/login" class="btn btn-outline-light btn-sm me-2">
                    <i class="fas fa-sign-in-alt me-1"></i>ç™»å½•
                </a>
                <a href="/admin/dashboard" class="btn btn-outline-light btn-sm me-2">
                    <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                </a>
                <a href="/test-url-login.html" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-link me-1"></i>URLç™»å½•æµ‹è¯•
                </a>
            </div>
        </div>
    </nav>

    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Admin JS -->
    <script src="/js/admin.js"></script>

    <script>
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        $(document).ready(function () {
            log('ğŸš€ ç³»ç»Ÿå±‚é¢Tokenæµ‹è¯•é¡µé¢å·²åŠ è½½');
            refreshTokenStatus();

            // è®¾ç½®å…¨å±€AJAXé”™è¯¯å¤„ç†
            $(document).ajaxError(function (event, xhr, settings, error) {
                log('âŒ AJAXé”™è¯¯: ' + xhr.status + ' ' + error);
                log('è¯·æ±‚URL: ' + settings.url);
                $('#apiResponseStatus').val(xhr.status + ' ' + error);
                $('#apiResponseContent').val(xhr.responseText || 'æ— å“åº”å†…å®¹');
            });
        });

        // åˆ·æ–°tokençŠ¶æ€
        function refreshTokenStatus() {
            log('ğŸ”„ åˆ·æ–°tokençŠ¶æ€...');

            // è·å–localStorageä¸­çš„token
            const localStorageToken = AdminToken.getToken();
            $('#localStorageToken').val(localStorageToken ? localStorageToken.substring(0, 30) + '...' : 'æ— ');

            // è·å–Cookieä¸­çš„token
            const cookieToken = AdminToken.getCookie();
            $('#cookieToken').val(cookieToken ? cookieToken.substring(0, 30) + '...' : 'æ— ');

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const isLoggedIn = AdminToken.isLoggedIn();
            $('#loginStatus').val(isLoggedIn ? 'å·²ç™»å½•' : 'æœªç™»å½•');

            log('âœ… TokençŠ¶æ€å·²åˆ·æ–°');
        }

        // æµ‹è¯•æ— tokençš„APIè¯·æ±‚
        function testApiWithoutToken() {
            log('ğŸ§ª æµ‹è¯•æ— tokençš„APIè¯·æ±‚...');

            // ä¸´æ—¶æ¸…é™¤Authorizationå¤´æ¥æ¨¡æ‹Ÿæ— tokenè¯·æ±‚
            $.ajax({
                url: '/admin/api/system/status',
                method: 'GET',
                headers: {
                    'Authorization': ''  // ç©ºAuthorizationå¤´
                },
                success: function (data) {
                    log('âœ… æ— tokenè¯·æ±‚æˆåŠŸ');
                    $('#apiResponseStatus').val('200 OK');
                    $('#apiResponseContent').val(JSON.stringify(data, null, 2));
                },
                error: function (xhr) {
                    log('âŒ æ— tokenè¯·æ±‚å¤±è´¥: ' + xhr.status);
                    $('#apiResponseStatus').val(xhr.status + ' ' + xhr.statusText);
                    $('#apiResponseContent').val(xhr.responseText || 'æ— å“åº”å†…å®¹');
                }
            });
        }

        // æµ‹è¯•ç³»ç»Ÿè‡ªåŠ¨tokençš„APIè¯·æ±‚
        function testApiWithToken() {
            log('ğŸ” æµ‹è¯•ç³»ç»Ÿè‡ªåŠ¨tokençš„APIè¯·æ±‚...');

            // ä¸è®¾ç½®Authorizationå¤´ï¼Œè®©TokenAutoHeaderFilterè‡ªåŠ¨å¤„ç†
            $.ajax({
                url: '/admin/api/system/status',
                method: 'GET',
                success: function (data) {
                    log('âœ… è‡ªåŠ¨tokenè¯·æ±‚æˆåŠŸ');
                    $('#apiResponseStatus').val('200 OK');
                    $('#apiResponseContent').val(JSON.stringify(data, null, 2));
                },
                error: function (xhr) {
                    log('âŒ è‡ªåŠ¨tokenè¯·æ±‚å¤±è´¥: ' + xhr.status);
                    $('#apiResponseStatus').val(xhr.status + ' ' + xhr.statusText);
                    $('#apiResponseContent').val(xhr.responseText || 'æ— å“åº”å†…å®¹');
                }
            });
        }

        // æ—¥å¿—è®°å½•
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `<div>[${timestamp}] ${message}</div>`;
            $('#operationLog').append(logEntry);
            $('#operationLog').scrollTop($('#operationLog')[0].scrollHeight);
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            $('#operationLog').html('<div>æ—¥å¿—å·²æ¸…ç©º</div>');
        }
    </script>
</body>

</html>