# æƒé™éªŒè¯æœºåˆ¶è¯´æ˜

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

æœ¬ç³»ç»Ÿå®ç°äº†**åŒé‡æƒé™éªŒè¯æœºåˆ¶**ï¼Œæ™ºèƒ½åŒºåˆ†ç”¨æˆ·è°ƒç”¨å’ŒæœåŠ¡é—´è°ƒç”¨ï¼Œæä¾›ä¸åŒçš„æƒé™éªŒè¯ç­–ç•¥ã€‚

## ğŸ”„ ä¸¤ç§è°ƒç”¨æ–¹å¼å¯¹æ¯”

| ç‰¹æ€§ | ğŸ‘¤ ç”¨æˆ·è°ƒç”¨ | ğŸ”— æœåŠ¡é—´è°ƒç”¨ |
|-----|------------|-------------|
| **è°ƒç”¨è€…** | å‰ç«¯ç”¨æˆ·ï¼ˆWeb/Mobileï¼‰ | å¾®æœåŠ¡ä¹‹é—´ |
| **è®¤è¯æ–¹å¼** | Spring Securityç”¨æˆ·è®¤è¯ | appId + æœåŠ¡Token |
| **è¯·æ±‚å¤´è¦æ±‚** | `Authorization: Bearer {user_token}` | `X-Service-Call: true`<br/>`appid: {app_id}`<br/>`Authorization: Bearer {service_token}` |
| **æƒé™éªŒè¯** | ç”¨æˆ·è§’è‰²æƒé™ï¼ˆRBACï¼‰ | æ¥å£æƒé™åˆ—è¡¨åŒ¹é… |
| **Tokenç±»å‹** | ç”¨æˆ·JWT Tokenï¼ˆæœ‰è¿‡æœŸæ—¶é—´ï¼‰ | æœåŠ¡æ°¸ä¹…Tokenï¼ˆæ— è¿‡æœŸæ—¶é—´ï¼‰ |
| **éªŒè¯Filter** | Spring Securityæ ‡å‡†æµç¨‹ | ServicePermissionFilter |

## ğŸš€ éªŒè¯æµç¨‹è¯¦è§£

### 1. è¯·æ±‚åˆ°è¾¾ServicePermissionFilter

```java
@Override
protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) {
    String serviceCallFlag = request.getHeader("X-Service-Call");
    
    if (!"true".equals(serviceCallFlag)) {
        // ğŸ‘¤ ç”¨æˆ·è°ƒç”¨ï¼šè·³è¿‡æœåŠ¡æƒé™éªŒè¯ï¼Œèµ°Spring Security
        filterChain.doFilter(request, response);
        return;
    }
    
    // ğŸ”— æœåŠ¡é—´è°ƒç”¨ï¼šè¿›è¡ŒappId + tokenéªŒè¯
    // ... éªŒè¯é€»è¾‘
}
```

### 2. ç”¨æˆ·è°ƒç”¨æµç¨‹
```
å‰ç«¯è¯·æ±‚ â†’ ServicePermissionFilter (è·³è¿‡) â†’ Spring Security â†’ ç”¨æˆ·è®¤è¯ â†’ è§’è‰²æƒé™æ£€æŸ¥ â†’ ä¸šåŠ¡Controller
```

### 3. æœåŠ¡é—´è°ƒç”¨æµç¨‹
```
æœåŠ¡è¯·æ±‚ â†’ ServicePermissionFilter â†’ éªŒè¯X-Service-Call â†’ éªŒè¯appId â†’ éªŒè¯Token â†’ æŸ¥è¯¢æƒé™ç¼“å­˜ â†’ åŒ¹é…æ¥å£æƒé™ â†’ ä¸šåŠ¡Controller
```

## ğŸ“ å®é™…ä½¿ç”¨ç¤ºä¾‹

### ç”¨æˆ·è°ƒç”¨ç¤ºä¾‹

#### åœºæ™¯ï¼šç”¨æˆ·æŸ¥çœ‹ä¸ªäººèµ„æ–™
```bash
# ç”¨æˆ·ç™»å½•
curl -X POST "http://localhost:8080/login" \
     -H "Content-Type: application/json" \
     -d '{"username": "admin", "password": "123456"}'

```


```bash
# ç”¨æˆ·è°ƒç”¨ä¸ªäººèµ„æ–™æ¥å£
curl -X GET "http://localhost:8080/api/user/profile" \
     -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhZG1pbiIsImxvZ2luVHlwZSI6IlVTRVJfTE9HSU4iLCJleHAiOjE3NTYyNDIwOTUsImF1dGhvcml0aWVzIjoiUk9MRV9BRE1JTiJ9.hLeYToGDExvSjJmlrKHc2NAaA1D79hwrgVhRS2R1hRk"
```

**æƒé™éªŒè¯è¿‡ç¨‹ï¼š**
1. ServicePermissionFilteræ£€æŸ¥æ— `X-Service-Call`å¤´ï¼Œè·³è¿‡
2. Spring SecurityéªŒè¯ç”¨æˆ·Token
3. æå–ç”¨æˆ·ä¿¡æ¯å’Œè§’è‰²
4. æ‰§è¡Œä¸šåŠ¡é€»è¾‘

### æœåŠ¡é—´è°ƒç”¨ç¤ºä¾‹

#### åœºæ™¯ï¼šç”¨æˆ·æœåŠ¡è°ƒç”¨é€šçŸ¥æœåŠ¡å‘é€é‚®ä»¶
```bash
# ç”¨æˆ·æœåŠ¡å‘é€šçŸ¥æœåŠ¡å‘é€é‚®ä»¶è¯·æ±‚
curl -X POST "http://localhost:8080/api/notification/email/send" \
     -H "Content-Type: application/json" \
     -H "X-Service-Call: true" \
     -H "appid: 1750123456789012345" \
     -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJ6eHktaG9zcGl0YWwtYWRtaW4iLCJzdWIiOiIxNzUwMTIzNDU2Nzg5MDEyMzQ1In0.xxx" \
     -d '{
       "to": "user@example.com",
       "subject": "æ¬¢è¿æ³¨å†Œ",
       "content": "æ¬¢è¿æ‚¨æ³¨å†Œæˆ‘ä»¬çš„æœåŠ¡ï¼"
     }'
```

**æƒé™éªŒè¯è¿‡ç¨‹ï¼š**
1. ServicePermissionFilteræ£€æŸ¥åˆ°`X-Service-Call: true`
2. æå–å¹¶éªŒè¯`appid: 1750123456789012345`
3. éªŒè¯æœåŠ¡Tokençš„æœ‰æ•ˆæ€§
4. ä»ç¼“å­˜æŸ¥è¯¢è¯¥åº”ç”¨çš„æƒé™åˆ—è¡¨ï¼š`["/api/notification/*", "/api/email/*"]`
5. åŒ¹é…è¯·æ±‚è·¯å¾„`/api/notification/email/send`ä¸æƒé™`/api/notification/*`
6. åŒ¹é…æˆåŠŸï¼Œæ”¾è¡Œè¯·æ±‚

## ğŸ”§ é…ç½®ç®¡ç†

### æœåŠ¡åº”ç”¨æ³¨å†Œï¼ˆä»…ADMINå¯æ“ä½œï¼‰
```bash
# ç®¡ç†å‘˜æ³¨å†Œæ–°çš„æœåŠ¡åº”ç”¨
curl -X POST "http://localhost:8080/api/service-app/register" \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer {admin_token}" \
     -d '{
       "appName": "è®¢å•æœåŠ¡",
       "allowedApis": ["/api/order/*", "/api/payment/*", "/api/inventory/check"],
       "createBy": "admin",
       "remark": "è®¢å•å’Œæ”¯ä»˜ç›¸å…³æœåŠ¡"
     }'
```

### Tokenç­¾å‘ï¼ˆä»…ADMINå¯æ“ä½œï¼‰
```bash
# ä¸ºæœåŠ¡åº”ç”¨ç­¾å‘æ°¸ä¹…Token
curl -X POST "http://localhost:8080/api/service-token/issue" \
     -H "Authorization: Bearer {admin_token}" \
     -d "appId=1750123456789012346" \
     -d "authCode=xyz789abc456def123" \
     -d "issueBy=admin"
```

## ğŸ¯ æƒé™åŒ¹é…è§„åˆ™

### é€šé…ç¬¦æ”¯æŒ
| é…ç½® | åŒ¹é…ç¤ºä¾‹ | è¯´æ˜ |
|-----|---------|------|
| `/api/user/*` | `/api/user/profile`<br/>`/api/user/settings` | å‰ç¼€åŒ¹é… |
| `*/export` | `/api/order/export`<br/>`/api/user/export` | åç¼€åŒ¹é… |
| `*` | æ‰€æœ‰æ¥å£ | å…¨åŒ¹é…ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰ |
| `/api/user/profile` | `/api/user/profile` | ç²¾ç¡®åŒ¹é… |

### å¤åˆæƒé™é…ç½®ç¤ºä¾‹
```json
{
    "appName": "ç”¨æˆ·æœåŠ¡",
    "allowedApis": [
        "/api/user/*",              // ç”¨æˆ·æ¨¡å—æ‰€æœ‰æ¥å£
        "/api/auth/validate",       // ç‰¹å®šè®¤è¯æ¥å£
        "/api/common/upload",       // æ–‡ä»¶ä¸Šä¼ æ¥å£
        "*/export",                 // æ‰€æœ‰å¯¼å‡ºæ¥å£
        "/api/system/health"        // å¥åº·æ£€æŸ¥æ¥å£
    ]
}
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### é«˜æ€§èƒ½ç¼“å­˜æœºåˆ¶
```java
// å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½æ‰€æœ‰æƒé™åˆ°å†…å­˜
private final ConcurrentHashMap<String, List<String>> permissionCache = new ConcurrentHashMap<>();

// æƒé™éªŒè¯æ—¶ç›´æ¥ä»å†…å­˜æŸ¥è¯¢ï¼ˆæ¯«ç§’çº§ï¼‰
public boolean hasPermission(String appId, String apiPath) {
    List<String> allowedApis = permissionCache.get(appId);
    // å¿«é€ŸåŒ¹é…ç®—æ³•
}
```

### ç¼“å­˜ç»Ÿè®¡ç›‘æ§
```bash
# æŸ¥çœ‹ç¼“å­˜æ€§èƒ½
curl "http://localhost:8080/api/permission-cache/stats"
# å“åº”: "ç¼“å­˜ç»Ÿè®¡ - æ€»è¯·æ±‚: 10000, å‘½ä¸­: 9500, æœªå‘½ä¸­: 500, å‘½ä¸­ç‡: 95.00%, ç¼“å­˜åº”ç”¨æ•°: 5"
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### 1. Tokenå®‰å…¨
- **ç”¨æˆ·Token**ï¼šæœ‰è¿‡æœŸæ—¶é—´ï¼Œå®šæœŸåˆ·æ–°
- **æœåŠ¡Token**ï¼šæ°¸ä¹…æœ‰æ•ˆï¼Œç­¾åéªŒè¯ï¼Œå®šæœŸè½®æ¢

### 2. æƒé™éš”ç¦»
- **ç®¡ç†æƒé™**ï¼šåªæœ‰ADMINè§’è‰²å¯ä»¥æ³¨å†Œåº”ç”¨ã€ç­¾å‘Token
- **ä¸šåŠ¡æƒé™**ï¼šåŸºäºè§’è‰²çš„ç”¨æˆ·æƒé™æ§åˆ¶
- **æœåŠ¡æƒé™**ï¼šåŸºäºæ¥å£åˆ—è¡¨çš„ç²¾ç¡®æƒé™æ§åˆ¶

### 3. é˜²æŠ¤æœºåˆ¶
- **è¯·æ±‚å¤´éªŒè¯**ï¼šå¿…é¡»æœ‰æ­£ç¡®çš„æ ‡è¯†æ‰è¿›å…¥å¯¹åº”éªŒè¯æµç¨‹
- **Tokenç»‘å®š**ï¼šæœåŠ¡Tokenä¸appIdå¼ºç»‘å®š
- **ç™½åå•æœºåˆ¶**ï¼šé™æ€èµ„æºå’Œç®¡ç†æ¥å£è‡ªåŠ¨æ’é™¤

## ğŸ‰ ç³»ç»Ÿä¼˜åŠ¿

âœ… **æ™ºèƒ½åˆ†æµ**ï¼šè‡ªåŠ¨è¯†åˆ«è°ƒç”¨ç±»å‹ï¼Œé‡‡ç”¨ä¸åŒéªŒè¯ç­–ç•¥  
âœ… **é«˜æ€§èƒ½**ï¼šå†…å­˜ç¼“å­˜ï¼Œæ¯«ç§’çº§æƒé™éªŒè¯  
âœ… **é«˜å®‰å…¨**ï¼šåŒé‡æƒé™æ§åˆ¶ï¼Œå¤šå±‚é˜²æŠ¤æœºåˆ¶  
âœ… **æ˜“ç®¡ç†**ï¼šå®Œå–„çš„ç®¡ç†æ¥å£ï¼Œæ”¯æŒåŠ¨æ€é…ç½®  
âœ… **æ˜“æ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒè‡ªå®šä¹‰æƒé™ç­–ç•¥  
âœ… **æ˜“ç›‘æ§**ï¼šè¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯å’Œæ—¥å¿—è®°å½•

è¿™ç§è®¾è®¡æ—¢ä¿è¯äº†ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œåˆä¿æŒäº†è‰¯å¥½çš„æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ï¼ğŸš€
